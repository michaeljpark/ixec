<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IXEC Hybrid Storage</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PropTypes & FlipMove for Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-flip-move/2.9.14/react-flip-move.min.js"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        :root {
            --bg-color: #f3f4f6;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --primary-blue: #3b82f6;
            --primary-blue-hover: #2563eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --purple-accent: #a855f7;
            --font-family: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        #root {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            position: relative;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            transition: transform 0.3s ease;
            z-index: 50;
            flex-shrink: 0;
            height: 100%; /* Ensure full height */
        }

        .sidebar-scroll-area {
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Crucial for flex scrolling */
            margin-right: -1rem; /* Compensate for padding to keep scrollbar at edge if visible */
            padding-right: 1rem;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .sidebar-scroll-area::-webkit-scrollbar {
            display: none;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .logo-img {
            height: 32px;
            width: auto;
        }

        .search-bar {
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            color: var(--text-secondary);
        }

        .search-bar input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        .nav-item.active {
            background-color: #eff6ff;
            color: var(--primary-blue);
        }

        .nav-item.dragging {
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            box-shadow: none;
        }

        .nav-item.dragging>* {
            opacity: 0;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .user-profile {
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            font-weight: 600;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .breadcrumbs span:last-child {
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: var(--success-green);
            border-radius: 50%;
            flex-shrink: 0; /* Prevent squashing */
        }

        /* Hero Section */
        .hero-card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            align-items: center;
        }

        .device-image {
            width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            background-color: #f0f0f0;
        }

        .device-info {
            flex: 1;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .device-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .device-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }

        .remote-btn {
            background-color: #111827;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .remote-btn:hover {
            background-color: #000000;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }

        .spec-item h4 {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .spec-item p {
            font-weight: 600;
            font-size: 1rem;
        }

        .warranty-active {
            color: var(--success-green);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.25rem;
            border-radius: 50px;
            width: fit-content;
            margin-bottom: 2rem;
        }

        .tab {
            flex: 1;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .tab.active {
            background-color: white;
            color: var(--text-primary);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .add-btn {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.5rem;
            background-color: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .add-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            background-color: #eff6ff;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .icon-green {
            background-color: #d1fae5;
            color: var(--success-green);
        }

        .icon-blue {
            background-color: #dbeafe;
            color: var(--primary-blue);
        }

        .icon-purple {
            background-color: #f3e8ff;
            color: var(--purple-accent);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            background-color: var(--bg-color);
            color: var(--text-secondary);
        }

        .card-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .card-subvalue {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .progress-bar {
            height: 6px;
            background-color: #f3f4f6;
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-blue);
            border-radius: 3px;
        }

        /* Bottom Section */
        .bottom-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .system-load {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .load-item {
            margin-bottom: 1.5rem;
        }

        .load-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .ai-optimizer {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 20px;
            padding: 1.5rem;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .ai-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .ai-desc {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .optimize-btn {
            background-color: white;
            color: var(--primary-blue);
            border: none;
            padding: 0.75rem;
            border-radius: 25px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: transform 0.2s;
        }

        .optimize-btn:hover {
            transform: translateY(-2px);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .specs-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .bottom-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            html {
                font-size: 90%;
            }

            #root {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                left: -260px;
                height: 100%;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.open {
                transform: translateX(260px);
            }

            .menu-toggle {
                display: block;
                margin-bottom: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .hero-card {
                flex-direction: column;
                text-align: center;
                position: relative; /* Added for button positioning */
            }

            .device-image {
                width: 100%;
                height: auto;
            }

            .device-header {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .remote-btn {
                position: absolute;
                bottom: 1rem;
                right: 1rem;
                width: 48px;
                height: 48px;
                border-radius: 50% !important;
                padding: 0 !important;
                justify-content: center;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                z-index: 10;
            }

            .remote-btn span {
                display: none;
            }

            /* Hide tab text on mobile for inactive tabs */
            .tab:not(.active) .tab-text {
                display: none;
            }
            
            .tabs {
                gap: 0.25rem !important;
            }

            .tab {
                padding: 0.5rem 0 !important;
                font-size: 0.7rem !important; /* Smaller text on mobile */
                justify-content: center !important;
            }

            .tab.active {
                flex: 2.5 !important;
            }

            .tab i {
                font-size: 1.1rem !important; /* Slightly larger icon */
                flex-shrink: 0;
                display: inline-block !important; /* Ensure it takes space */
                min-width: 1.1rem;
                text-align: center;
                visibility: visible !important;
                opacity: 1 !important;
                color: inherit;
                line-height: 1;
                display: flex !important;
                align-items: center;
                justify-content: center;
            }

            /* Hide icon for active tab on mobile (Text only) */
            .tab.active i {
                display: none !important;
            }

            .specs-grid {
                grid-template-columns: 1fr;
                text-align: left;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .breadcrumbs {
                font-size: 0.75rem; /* Reduced text size */
                flex-wrap: wrap;
            }

            .tabs {
                width: 100%;
                overflow-x: auto; /* Allow scrolling if needed */
                display: flex;
                justify-content: flex-start; /* Align start for scroll */
                gap: 0.5rem;
                padding-bottom: 0.5rem; /* Space for scrollbar */
            }

            .tab {
                white-space: nowrap;
                padding: 0.5rem 1rem; /* More comfortable padding */
                font-size: 0.8rem;
                flex: 0 0 auto; /* Don't shrink, allow scroll */
            }

            .tab i {
                display: none;
            }

            .status-dropdown {
                right: auto;
                left: 0;
                width: 100%; /* Full width dropdown on mobile */
                top: 110%; /* Slight gap */
            }

            .status-badge {
                width: 100%; /* Full width button */
                justify-content: center; /* Center content */
            }

            .card {
                padding: 1.25rem; /* Slightly reduced padding */
            }

            .hero-card {
                padding: 1.5rem;
            }

            .device-title {
                font-size: 1.75rem;
            }

            /* Improved Tab Scrolling */
            .tabs {
                width: 100%;
                overflow-x: auto;
                display: flex;
                justify-content: flex-start;
                gap: 0.5rem;
                padding-bottom: 0.25rem; /* Space for scrollbar */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling */
                scrollbar-width: none; /* Hide scrollbar Firefox */
            }
            
            .tabs::-webkit-scrollbar {
                display: none; /* Hide scrollbar Chrome/Safari */
            }

            .tab {
                white-space: nowrap;
                padding: 0.6rem 1.2rem !important;
                font-size: 0.9rem !important;
                flex: 0 0 auto !important; /* Override inline flex: 1 */
                background-color: transparent; /* Let the container background show or override */
                border-radius: 50px;
                color: #6b7280;
            }

            .tab.active {
                background-color: white !important;
                color: #111827 !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            /* Restore icons in tabs for mobile but keep them small/inline if needed, 
               or just keep text. The previous CSS hid icons. Let's try to show them if space permits 
               or keep them hidden if it's too crowded. 
               Let's actually SHOW icons and Text, but make font smaller. */
            
            .tab i {
                display: inline-block !important;
                margin-right: 0.5rem;
                font-size: 0.9rem !important;
            }

            .overlay {
                display: block;
            }

            /* AI Monitoring & Master Control & Optimization Mobile Overrides */
            .ai-monitoring-container h2,
            .master-access-container h2,
            .ai-optimization-title {
                font-size: 1.25rem !important;
            }

            .ai-monitoring-container p,
            .master-access-container p,
            .ai-optimization-container p {
                font-size: 0.9rem !important;
                line-height: 1.4 !important;
            }

            .ai-monitoring-container button,
            .master-access-container button {
                font-size: 0.9rem !important;
                padding: 0.75rem 1.5rem !important;
            }
            
            .master-access-container .master-access-icon-box {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }

            /* Dashboard AI Optimizer Card */
            .ai-optimizer .ai-title {
                font-size: 1.2rem !important;
            }
            
            .ai-optimizer .ai-desc {
                font-size: 0.8rem !important;
                margin-bottom: 1rem !important;
            }
            
            .ai-optimizer .optimize-btn {
                font-size: 0.9rem !important;
                padding: 0.6rem !important;
            }

            /* Target Device List Mobile Overrides */
            .device-list-item {
                padding: 0.5rem 0.75rem !important;
                gap: 0.5rem !important;
            }
            
            .device-icon-box {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.9rem !important;
            }
            
            .device-name {
                font-size: 0.85rem !important;
            }
            
            .device-check-box {
                width: 20px !important;
                height: 20px !important;
                flex-shrink: 0; /* Fix squashing */
            }

            .master-access-container {
                padding-bottom: 4rem !important; /* Add bottom padding */
            }
        }

        /* Onboarding Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: #ffffff;
            width: 90%;
            max-width: 400px;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            overflow: hidden;
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--primary-blue);
            width: 24px;
            border-radius: 4px;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(59, 130, 246, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        @keyframes pulse-ring-orange {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(249, 115, 22, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0);
            }
        }

        .status-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
            width: 220px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #f3f4f6;
        }

        .status-badge:hover .status-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .status-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: #374151;
            font-weight: 500;
        }

        .status-option:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        /* Staggered Animation Classes */
        .stagger-enter>* {
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .stagger-enter>*:nth-child(1) {
            animation-delay: 0.1s;
        }

        .stagger-enter>*:nth-child(2) {
            animation-delay: 0.2s;
        }

        .stagger-enter>*:nth-child(3) {
            animation-delay: 0.3s;
        }

        .stagger-enter>*:nth-child(4) {
            animation-delay: 0.4s;
        }

        .stagger-enter>*:nth-child(5) {
            animation-delay: 0.5s;
        }

        .stagger-exit>* {
            opacity: 1;
            animation: fadeOutDown 0.3s ease-in forwards;
        }

        .stagger-exit>*:nth-child(1) {
            animation-delay: 0s;
        }

        .stagger-exit>*:nth-child(2) {
            animation-delay: 0.05s;
        }

        .stagger-exit>*:nth-child(3) {
            animation-delay: 0.1s;
        }

        .stagger-exit>*:nth-child(4) {
            animation-delay: 0.15s;
        }

        .stagger-exit>*:nth-child(5) {
            animation-delay: 0.2s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        /* Grant Master Access Styles */
        .master-access-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 600px;
            padding: 2rem 0;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
            padding-top: 2rem;
        }

        .master-access-icon-box {
            width: 60px;
            height: 60px;
            background: #eff6ff;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            color: #3b82f6;
            font-size: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1);
        }

        @media (max-width: 768px) {
            .master-access-container {
                padding-top: 2rem;
                padding-left: 1rem;
                padding-right: 1rem;
                min-height: auto;
            }
        }

        /* AI Optimization Styles */
        .ai-optimization-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 70vh;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            padding-top: 15vh;
        }

        .ai-optimization-spinner {
            display: none;
        }

        .ai-optimization-icon {
            display: none;
        }

        .ai-optimization-title {
            font-size: 1.5rem !important;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #111827;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .ai-monitoring-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 70vh;
            padding-top: 15vh;
            padding-bottom: 2rem;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel">
        const { useState, useEffect, useRef, forwardRef } = React;
        const FlipMove = window.FlipMove;

        // Functional component wrapper for FlipMove compatibility
        const FunctionalArticle = forwardRef((props, ref) => (
            <div ref={ref} {...props}>
                {props.children}
            </div>
        ));

        const devicesData = [
            {
                id: 'macbook',
                icon: 'fa-laptop',
                name: 'MacBook Pro M1',
                status: 'Online • Storage 67%',
                image: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                serial: 'C02F3A4B5C6D',
                os: 'macOS Sonoma 14.2',
                specs: [
                    { label: 'Processor', value: 'Apple M1 Pro' },
                    { label: 'Memory', value: '16 GB Unified' },
                    { label: 'Disk', value: '512 GB SSD' },
                    { label: 'Warranty', value: 'Active', active: true }
                ],
                stats: {
                    diskHealth: { value: '94%', status: 'Normal', color: '#10b981' },
                    storage: { used: '342 GB', total: '512 GB', percent: 67 },
                    backup: { last: '1 minute ago', next: '14:00' }
                },
                load: {
                    cpu: 12,
                    memory: 45,
                    network: 20,
                    networkSpeed: '2.4 MB/s'
                },
                ai: {
                    title: '3 Background apps sleeping',
                    desc: 'Our AI detected high energy usage from "Chrome Helper". Sleeping these apps can extend battery life by ~45 mins.'
                },
                security: {
                    score: 98,
                    firewall: 'Active',
                    antivirus: 'XProtect',
                    lastScan: 'Today, 09:41 AM',
                    encryption: 'FileVault On',
                    issues: []
                },
                performance: {
                    uptime: '4 days, 2 hours',
                    processes: 215,
                    temperature: '42°C',
                    topApps: [
                        { name: 'Xcode', cpu: '4.2%', mem: '1.2 GB' },
                        { name: 'Chrome', cpu: '2.1%', mem: '850 MB' },
                        { name: 'Slack', cpu: '0.5%', mem: '420 MB' }
                    ]
                },
                aiInsights: {
                    history: [
                        { date: 'Today', action: 'Optimized memory usage', impact: 'Freed 2.1 GB' },
                        { date: 'Yesterday', action: 'Battery health check', impact: 'Optimal charging' }
                    ]
                }
            },
            {
                id: 'iphone',
                icon: 'fa-mobile-screen',
                name: 'iPhone 13 Pro',
                status: 'Ai - Monitoring • Storage 47%',
                image: 'https://images.unsplash.com/photo-1632661674596-df8be070a5c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                serial: 'F2L9X7K1J4M5',
                os: 'iOS 17.2',
                specs: [
                    { label: 'Processor', value: 'A15 Bionic' },
                    { label: 'Memory', value: '6 GB' },
                    { label: 'Storage', value: '256 GB' },
                    { label: 'Warranty', value: 'Expired', active: false }
                ],
                stats: {
                    diskHealth: { value: '98%', status: 'Good', color: '#10b981' },
                    storage: { used: '120 GB', total: '256 GB', percent: 47 },
                    backup: { last: '2 hours ago', next: '20:00' }
                },
                load: {
                    cpu: 5,
                    memory: 30,
                    network: 10,
                    networkSpeed: '1.2 MB/s'
                },
                ai: {
                    title: 'Photo Optimization',
                    desc: '2.4GB of similar photos detected. Merging them could save space.'
                },
                security: {
                    score: 100,
                    firewall: 'N/A',
                    antivirus: 'iOS Security',
                    lastScan: 'Continuous',
                    encryption: 'Data Protection',
                    issues: []
                },
                performance: {
                    uptime: '12 days',
                    processes: 45,
                    temperature: 'Normal',
                    topApps: [
                        { name: 'Instagram', cpu: '12%', mem: '350 MB' },
                        { name: 'Camera', cpu: '8%', mem: '200 MB' }
                    ]
                },
                aiInsights: {
                    history: [
                        { date: 'Today', action: 'Photo duplicate scan', impact: 'Found 2.4 GB' },
                        { date: '2 days ago', action: 'App refresh limit', impact: 'Saved 5% battery' }
                    ]
                }
            },
            {
                id: 'desktop',
                icon: 'fa-desktop',
                name: 'Desktop - Intel i5-13600K - L204E391',
                status: 'Offline • Last seen 2d ago',
                image: 'https://images.unsplash.com/photo-1587202372775-e229f172b9d7?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                serial: 'L204E391',
                os: 'Windows 11 Pro',
                specs: [
                    { label: 'Processor', value: 'i5-13600K' },
                    { label: 'Memory', value: '32 GB DDR5' },
                    { label: 'GPU', value: 'RTX 3070' },
                    { label: 'Warranty', value: 'Active', active: true }
                ],
                stats: {
                    diskHealth: { value: '100%', status: 'Excellent', color: '#10b981' },
                    storage: { used: '800 GB', total: '2 TB', percent: 40 },
                    backup: { last: 'Yesterday', next: '02:00' }
                },
                load: {
                    cpu: 8,
                    memory: 24,
                    network: 5,
                    networkSpeed: '100 MB/s'
                },
                ai: {
                    title: 'Driver Update',
                    desc: 'New Game Ready Driver available for RTX 3070. Update for better performance.'
                },
                security: {
                    score: 85,
                    firewall: 'Active',
                    antivirus: 'Windows Defender',
                    lastScan: 'Yesterday',
                    encryption: 'BitLocker On',
                    issues: [{ severity: 'low', msg: 'Optional update available' }]
                },
                performance: {
                    uptime: '1 day, 5 hours',
                    processes: 189,
                    temperature: '55°C',
                    topApps: [
                        { name: 'Steam', cpu: '0.1%', mem: '450 MB' },
                        { name: 'Discord', cpu: '1.2%', mem: '300 MB' },
                        { name: 'Firefox', cpu: '3.5%', mem: '1.1 GB' }
                    ]
                },
                aiInsights: {
                    history: [
                        { date: 'Yesterday', action: 'Game mode enabled', impact: 'Performance boost' },
                        { date: 'Last Week', action: 'Disk cleanup', impact: 'Freed 15 GB' }
                    ]
                }
            },
            {
                id: 'sandisk',
                icon: 'fa-hard-drive',
                name: 'SanDisk - Extreme Pro 1TB/200MBs',
                status: 'Ai - Data Optimizing • Storage 15%',
                image: 'https://images.unsplash.com/photo-1597852074816-d933c7d2b988?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                serial: 'SD-EXT-1TB-2024',
                os: 'ExFAT',
                specs: [
                    { label: 'Type', value: 'NVMe SSD' },
                    { label: 'Speed', value: '2000 MB/s' },
                    { label: 'Interface', value: 'USB 3.2' },
                    { label: 'Encryption', value: 'AES 256' }
                ],
                stats: {
                    diskHealth: { value: '99%', status: 'Good', color: '#10b981' },
                    storage: { used: '150 GB', total: '1 TB', percent: 15 },
                    backup: { last: 'N/A', next: 'Manual' }
                },
                load: {
                    cpu: 0,
                    memory: 0,
                    network: 0,
                    networkSpeed: '0 MB/s'
                },
                ai: {
                    title: 'File Organization',
                    desc: 'Large number of duplicate files detected in "Downloads".'
                },
                security: {
                    score: 100,
                    firewall: 'N/A',
                    antivirus: 'Scanned by Host',
                    lastScan: 'Just now',
                    encryption: 'Hardware AES',
                    issues: []
                },
                performance: {
                    uptime: 'Connected 2h',
                    processes: 0,
                    temperature: '38°C',
                    topApps: []
                },
                aiInsights: {
                    history: [
                        { date: 'Today', action: 'Virus scan', impact: 'No threats found' }
                    ]
                }
            }
        ];

        const Sidebar = ({ isOpen, toggleSidebar, selectedDeviceId, onSelectDevice, devices, onReorderDevices, clouds, onReorderClouds, onAddDevice, onAddCloud, selectedCloudId, onSelectCloud, optimizingLoadingMap, monitoringLoadingMap }) => {
            const [draggedItem, setDraggedItem] = useState(null);
            const [draggedType, setDraggedType] = useState(null); // 'device' or 'cloud'

            const getStatusColor = (status, itemId) => {
                if (!status) return 'transparent';
                const isOptimizing = optimizingLoadingMap[itemId];
                const isMonitoring = monitoringLoadingMap[itemId];

                if (status.includes('Online')) return '#10b981';
                if (status.includes('Ai - Data Optimizing')) return isOptimizing ? '#f97316' : '#3b82f6';
                if (status.includes('Ai - Monitoring')) return isMonitoring ? '#f97316' : '#3b82f6';
                if (status.includes('Ai')) return '#3b82f6';
                if (status.includes('Offline')) return '#9ca3af';
                return '#9ca3af';
            };

            const getStatusAnimation = (status, itemId) => {
                const isOptimizingLoading = optimizingLoadingMap[itemId];
                const isMonitoringLoading = monitoringLoadingMap[itemId];
                
                if (status.includes('Ai - Data Optimizing')) {
                    return isOptimizingLoading ? 'pulse-ring-orange 2s infinite' : 'pulse-ring 2s infinite';
                }
                if (status.includes('Ai - Monitoring')) {
                    return isMonitoringLoading ? 'pulse-ring-orange 2s infinite' : 'none';
                }
                return 'none';
            };

            const getStatusBoxShadow = (status, itemId) => {
                const isOptimizingLoading = optimizingLoadingMap[itemId];
                const isMonitoringLoading = monitoringLoadingMap[itemId];
                const color = getStatusColor(status, itemId);

                if (status.includes('Ai - Data Optimizing')) {
                    return `0 0 0 0 ${color}`;
                }
                if (status.includes('Ai - Monitoring') && isMonitoringLoading) {
                    return `0 0 0 0 ${color}`;
                }
                return 'none';
            };

            const handleDragStart = (e, index, type) => {
                e.dataTransfer.effectAllowed = "move";
                // Defer state update to ensure browser captures the full opacity element as the drag ghost
                setTimeout(() => {
                    setDraggedItem(index);
                    setDraggedType(type);
                }, 0);
            };

            const handleDragOver = (e, index, type) => {
                e.preventDefault();
                if (draggedItem === null || draggedType !== type) return;
                if (draggedItem !== index) {
                    const items = type === 'device' ? [...devices] : [...clouds];
                    const draggedItemContent = items[draggedItem];
                    items.splice(draggedItem, 1);
                    items.splice(index, 0, draggedItemContent);

                    setDraggedItem(index);
                    if (type === 'device') {
                        onReorderDevices(items);
                    } else {
                        onReorderClouds(items);
                    }
                }
            };

            const handleDragEnd = () => {
                setDraggedItem(null);
                setDraggedType(null);
            };

            return (
                <div className={`sidebar ${isOpen ? 'open' : ''}`}>
                    <div className="logo-container">
                        <img src="IXECWEB.svg" alt="IXEC Logo" className="logo-img" />
                    </div>

                    <div className="search-bar">
                        <i className="fa-solid fa-magnifying-glass"></i>
                        <input type="text" placeholder="Search devices..." />
                    </div>

                    <div className="sidebar-scroll-area">
                        <div className="nav-section">
                            <div className="nav-title">My Hardware</div>
                            <button className="add-btn" onClick={onAddDevice} style={{ marginBottom: '1rem' }}>
                                <i className="fa-solid fa-plus"></i> Add Device
                            </button>
                            <FlipMove duration={300} easing="ease-out">
                                {devices.map((item, index) => (
                                    <FunctionalArticle
                                        key={item.id}
                                        className={`nav-item ${selectedDeviceId === item.id ? 'active' : ''} ${draggedType === 'device' && draggedItem === index ? 'dragging' : ''}`}
                                        draggable
                                        onDragStart={(e) => handleDragStart(e, index, 'device')}
                                        onDragOver={(e) => handleDragOver(e, index, 'device')}
                                        onDragEnd={handleDragEnd}
                                        onClick={() => {
                                            onSelectDevice(item.id);
                                            if (window.innerWidth <= 768) toggleSidebar();
                                        }}
                                        style={{ cursor: 'grab' }}
                                    >
                                        <i className={`fa-solid ${item.icon}`}></i>
                                        <div className="user-info">
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                {item.status && (
                                                    <div style={{
                                                        width: '8px', height: '8px', borderRadius: '50%',
                                                        backgroundColor: getStatusColor(item.status, item.id),
                                                        boxShadow: getStatusBoxShadow(item.status, item.id),
                                                        animation: getStatusAnimation(item.status, item.id),
                                                        flexShrink: 0
                                                    }}></div>
                                                )}
                                                <div className="user-name">{item.name}</div>
                                            </div>
                                            {item.status && <div className="user-role" style={{ fontSize: '0.7rem', color: selectedDeviceId === item.id ? '#3b82f6' : '' }}>{item.status}</div>}
                                        </div>
                                        <i className="fa-solid fa-grip-lines" style={{ color: '#d1d5db', fontSize: '0.8rem', marginLeft: 'auto', cursor: 'grab' }}></i>
                                    </FunctionalArticle>
                                ))}
                            </FlipMove>
                        </div>

                        <div className="nav-section">
                            <div className="nav-title">Cloud Services</div>
                            <button className="add-btn" onClick={onAddCloud} style={{ marginBottom: '1rem' }}>
                                <i className="fa-solid fa-plus"></i> Add API
                            </button>
                            <FlipMove duration={300} easing="ease-out">
                                {clouds.map((item, index) => (
                                    <FunctionalArticle
                                        key={item.id}
                                        className={`nav-item ${selectedCloudId === item.id ? 'active' : ''} ${draggedType === 'cloud' && draggedItem === index ? 'dragging' : ''}`}
                                        draggable
                                        onDragStart={(e) => handleDragStart(e, index, 'cloud')}
                                        onDragOver={(e) => handleDragOver(e, index, 'cloud')}
                                        onDragEnd={handleDragEnd}
                                        onClick={() => {
                                            onSelectCloud(item.id);
                                            if (window.innerWidth <= 768) toggleSidebar();
                                        }}
                                        style={{ cursor: 'grab' }}
                                    >
                                        <i className={item.icon}></i>
                                        <div className="user-info">
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                {item.status && (
                                                    <div style={{
                                                        width: '8px', height: '8px', borderRadius: '50%',
                                                        backgroundColor: getStatusColor(item.status, item.id),
                                                        boxShadow: getStatusBoxShadow(item.status, item.id),
                                                        animation: getStatusAnimation(item.status, item.id),
                                                        flexShrink: 0
                                                    }}></div>
                                                )}
                                                <div className="user-name">{item.name}</div>
                                            </div>
                                            {item.status && <div className="user-role" style={{ fontSize: '0.7rem', color: selectedCloudId === item.id ? '#3b82f6' : '' }}>{item.status}</div>}
                                        </div>
                                        <i className="fa-solid fa-grip-lines" style={{ color: '#d1d5db', fontSize: '0.8rem', marginLeft: 'auto', cursor: 'grab' }}></i>
                                    </FunctionalArticle>
                                ))}
                            </FlipMove>
                        </div>
                    </div>

                    <div className="user-profile">
                        <div className="avatar">TU</div>
                        <div className="user-info">
                            <div className="user-name">test_user</div>
                            <div className="user-role">SysAdmin</div>
                        </div>
                        <i className="fa-solid fa-gear" style={{ color: '#9ca3af', cursor: 'pointer' }}></i>
                    </div>
                </div>
            );
        };

        // Generate ~128 nodes for visualization
        const generateFileSystemData = () => {
            const createNode = (name, children = []) => ({ name, children: children.length ? children : undefined, value: Math.random() * 100 });
            const createLeaves = (prefix, count) => Array.from({ length: count }, (_, i) => createNode(`${prefix}_${i + 1}.${['ts','tsx','css','svg'][i%4]}`));
            
            return {
                name: "Project Root",
                children: [
                    createNode("src", [
                        createNode("components", [
                            createNode("core", createLeaves("Core", 8)),
                            createNode("layout", createLeaves("Layout", 6)),
                            createNode("widgets", createLeaves("Widget", 12)),
                            createNode("forms", createLeaves("Form", 8))
                        ]),
                        createNode("features", [
                            createNode("auth", createLeaves("Auth", 5)),
                            createNode("dashboard", createLeaves("Dash", 10)),
                            createNode("settings", createLeaves("Set", 6))
                        ]),
                        createNode("utils", createLeaves("Util", 15)),
                        createNode("assets", createLeaves("Asset", 10))
                    ]),
                    createNode("public", createLeaves("Pub", 8)),
                    createNode("tests", [
                        createNode("unit", createLeaves("Test", 15)),
                        createNode("e2e", createLeaves("Spec", 8))
                    ]),
                    createNode("docs", createLeaves("Doc", 5))
                ]
            };
        };

        const fileSystemData = {
            macbook: generateFileSystemData(),
            iphone: generateFileSystemData(),
            desktop: generateFileSystemData(),
            sandisk: generateFileSystemData()
        };

        const FileTreeViz = ({ data }) => {
            const svgRef = React.useRef(null);
            const [activeNodeIndex, setActiveNodeIndex] = useState(0);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                if (!isMobile || !data) return;
                
                const root = d3.hierarchy(data);
                const leaves = root.leaves();
                const count = leaves.length;

                const interval = setInterval(() => {
                    setActiveNodeIndex(prev => (prev + 1) % count);
                }, 1000);

                return () => clearInterval(interval);
            }, [isMobile, data]);

            useEffect(() => {
                if (!data || !svgRef.current) return;

                // Adjusted width for mobile padding (1rem * 2 = 32px) + safety
                const width = isMobile ? window.innerWidth - 48 : 800; 
                const height = isMobile ? width * 1.1 : 600; 
                
                // Minimal padding on mobile to maximize tree size
                const radius = Math.min(width, height) / 2 - (isMobile ? 0 : 100); 
                const innerRadius = isMobile ? 60 : 80; // Increased inner radius on mobile for center text

                // Clear previous
                d3.select(svgRef.current).selectAll("*").remove();

                const svg = d3.select(svgRef.current)
                    .attr("width", "100%")
                    .attr("height", height)
                    .attr("viewBox", [-width / 2, -height / 2, width, height])
                    .append("g");

                // Add Pulse Animation
                const defs = svg.append("defs");
                defs.append("style").text(`
                    @keyframes ripple {
                        0% { r: 6px; opacity: 0.6; stroke-width: 0; }
                        100% { r: 20px; opacity: 0; stroke-width: 0; }
                    }
                    .ripple-circle {
                        animation: ripple 1.5s infinite ease-out;
                        fill: #3b82f6;
                    }
                `);

                // Cluster layout
                const cluster = d3.cluster()
                    .size([2 * Math.PI, radius - innerRadius]); // Available radial space

                const root = d3.hierarchy(data);
                cluster(root);
                
                const leaves = root.leaves();
                const activeNode = isMobile ? leaves[activeNodeIndex] : null;

                // Adjust radius by adding innerRadius to create the hole
                root.each(d => {
                    d.y = d.y + innerRadius;
                });

                // Links
                svg.append("g")
                    .selectAll("path")
                    .data(root.links())
                    .join("path")
                    .attr("d", d3.linkRadial()
                        .angle(d => d.x)
                        .radius(d => d.y))
                    .style("fill", "none")
                    .style("stroke", "#3b82f6")
                    .style("stroke-width", 1)
                    .style("stroke-opacity", 0.4);

                // Nodes
                const node = svg.append("g")
                    .selectAll("g")
                    .data(root.descendants())
                    .join("g")
                    .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`);

                // Pulse effect for active node
                if (isMobile && activeNode) {
                    node.filter(d => d === activeNode)
                        .append("circle")
                        .attr("class", "ripple-circle");
                }

                node.append("circle")
                    .attr("r", d => {
                        if (isMobile && d === activeNode) return 6;
                        return d.children ? 2 : 3;
                    })
                    .style("fill", d => {
                        if (isMobile && d === activeNode) return "#3b82f6";
                        return d.children ? "#3b82f6" : "#fff";
                    })
                    .style("stroke", "#3b82f6")
                    .style("stroke-width", 1.5);

                // Labels (only for leaves or specific depth to avoid clutter with 128 nodes)
                if (!isMobile) {
                    node.filter(d => !d.children)
                        .append("text")
                        .attr("dy", "0.31em")
                        .attr("x", d => d.x < Math.PI ? 6 : -6)
                        .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
                        .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
                        .text(d => d.data.name)
                        .style("font-size", "9px")
                        .style("font-family", "Inter, sans-serif")
                        .style("fill", "#6b7280")
                        .style("opacity", 0.8);
                }

                // Center Text for Mobile
                if (isMobile && activeNode) {
                    svg.append("text")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("text-anchor", "middle")
                        .attr("dominant-baseline", "middle")
                        .text(activeNode.data.name)
                        .style("font-size", "14px")
                        .style("font-weight", "bold")
                        .style("fill", "#111827")
                        .style("font-family", "Inter, sans-serif");
                        
                    svg.append("text")
                        .attr("x", 0)
                        .attr("y", 16)
                        .attr("text-anchor", "middle")
                        .attr("dominant-baseline", "middle")
                        .text("Scanning...")
                        .style("font-size", "10px")
                        .style("fill", "#6b7280")
                        .style("font-family", "Inter, sans-serif");
                }

            }, [data, isMobile, activeNodeIndex]);

            return <svg ref={svgRef} style={{ width: '100%', height: 'auto', background: '#ffffff', borderRadius: '12px', marginTop: '1rem' }}></svg>;
        };

        const FileUsageViz = ({ data }) => {
            const svgRef = React.useRef(null);
            const containerRef = React.useRef(null);
            const [selectedNode, setSelectedNode] = useState(null);
            const [sliderY, setSliderY] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // Memoize data and dimensions
            const { series, height, margin, containerWidth, containerHeight } = React.useMemo(() => {
                // 1. Prepare Categories
                const categories = [];
                const traverse = (node) => {
                    if (node.children) {
                        node.children.forEach(traverse);
                    } else {
                        categories.push(node.name);
                    }
                };
                traverse(data);

                const cutoffIndex = categories.findIndex(c => c.includes("Q1 Report"));
                const filteredCategories = cutoffIndex !== -1 ? categories.slice(0, cutoffIndex) : categories;
                const displayCategories = filteredCategories.slice(0, 15);

                // 2. Generate Data
                const n = 100;
                const seriesData = displayCategories.map(cat => {
                    const values = [];
                    let val = Math.random() * 40 + 10;
                    for (let i = 0; i < n; i++) {
                        let change = (Math.random() - 0.5) * 15;
                        if (Math.random() < 0.05) change += (Math.random() * 40 + 20);
                        if (Math.random() < 0.05) change -= (Math.random() * 40 + 20);
                        val += change;
                        val = Math.max(2, Math.min(120, val));
                        values.push(val);
                    }
                    const smoothed = [];
                    const windowSize = 2;
                    for (let i = 0; i < n; i++) {
                        let sum = 0;
                        let count = 0;
                        for (let j = Math.max(0, i - windowSize); j < Math.min(n, i + windowSize + 1); j++) {
                            sum += values[j];
                            count++;
                        }
                        smoothed.push(sum / count);
                    }
                    return { 
                        name: cat, 
                        values: smoothed,
                        totalSize: (Math.random() * 50 + 1).toFixed(1) + ' GB'
                    };
                });

                const m = { 
                    top: isMobile ? 60 : 100, 
                    right: isMobile ? 10 : 30, 
                    bottom: isMobile ? 40 : 50, 
                    left: isMobile ? 40 : 160 
                };
                
                const cWidth = isMobile ? window.innerWidth - 64 : 800;
                const cHeight = isMobile ? cWidth * 1.33 : 600;
                const h = cHeight - m.top - m.bottom;

                return { series: seriesData, height: h, margin: m, containerWidth: cWidth, containerHeight: cHeight };
            }, [data, isMobile]);

            // Update selected node based on slider position
            useEffect(() => {
                if (!series.length) return;
                const step = height / series.length;
                // Fix misalignment: Visual peak of graph i is at (i - 0.8) * step.
                // Visible strip is roughly [i-0.8, i+0.2]. Center is i-0.3.
                // So if sliderY/step is k, we want i such that k approx i - 0.3.
                // i = floor(k + 0.8).
                const index = Math.min(series.length - 1, Math.max(0, Math.floor(sliderY / step + 0.8)));
                setSelectedNode(series[index]);
            }, [sliderY, series, height]);

            // Drag Logic (Mobile) & Hover Logic (Desktop)
            const updateSlider = (clientY) => {
                if (!svgRef.current) return;
                const rect = svgRef.current.getBoundingClientRect();
                const scale = containerHeight / rect.height;
                const relativeY = (clientY - rect.top) * scale - margin.top;
                const clampedY = Math.max(0, Math.min(height, relativeY));
                setSliderY(clampedY);
            };

            const handleDragStart = (clientY) => {
                setIsDragging(true);
                updateSlider(clientY);
            };

            const handleDesktopHover = (e) => {
                if (!isMobile) {
                    updateSlider(e.clientY);
                }
            };

            useEffect(() => {
                const handleMove = (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        updateSlider(e.clientY || e.touches[0].clientY);
                    }
                };
                const handleUp = () => setIsDragging(false);

                if (isDragging) {
                    window.addEventListener('mousemove', handleMove);
                    window.addEventListener('mouseup', handleUp);
                    window.addEventListener('touchmove', handleMove, { passive: false });
                    window.addEventListener('touchend', handleUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMove);
                    window.removeEventListener('mouseup', handleUp);
                    window.removeEventListener('touchmove', handleMove);
                    window.removeEventListener('touchend', handleUp);
                };
            }, [isDragging, height, margin.top]);

            // D3 Render - Initialization
            useEffect(() => {
                if (!svgRef.current || !series.length) return;

                const width = containerWidth - margin.left - margin.right;
                const overlap = 0.8;

                d3.select(svgRef.current).selectAll("*").remove();

                const svg = d3.select(svgRef.current)
                    .attr("width", "100%")
                    .attr("height", containerHeight)
                    .attr("viewBox", [0, 0, containerWidth, containerHeight])
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleLinear().domain([0, 100]).range([0, width]);
                const y = d3.scaleBand().domain(series.map(d => d.name)).range([0, height]).paddingInner(1);
                const yHeight = d3.scaleLinear().domain([0, 120]).range([y.step() * (1 + overlap) * 1.5, 0]);

                const area = d3.area().curve(d3.curveBasis).x((d, i) => x(i)).y0(yHeight(0)).y1(d => yHeight(d));
                const line = d3.line().curve(d3.curveBasis).x((d, i) => x(i)).y(d => yHeight(d));

                const defs = svg.append("defs");
                defs.append("clipPath")
                    .attr("id", "viz-clip")
                    .append("rect")
                    .attr("x", -margin.left).attr("y", -margin.top).attr("width", width + margin.left).attr("height", height + margin.top);

                // Add Pulse Animation Style
                defs.append("style").text(`
                    @keyframes ridgePulse {
                        0% { stroke-width: 2px; filter: drop-shadow(0 0 1px rgba(59, 130, 246, 0.5)); }
                        50% { stroke-width: 4px; filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.8)); }
                        100% { stroke-width: 2px; filter: drop-shadow(0 0 1px rgba(59, 130, 246, 0.5)); }
                    }
                    .ridge-line.active {
                        animation: ridgePulse 2s infinite ease-in-out;
                        stroke: #2563eb;
                        stroke-opacity: 1;
                    }
                    .ridge-area.active {
                        fill-opacity: 0.8;
                        fill: #bfdbfe;
                    }
                `);

                const ridges = svg.append("g")
                    .attr("clip-path", "url(#viz-clip)")
                    .selectAll("g")
                    .data(series)
                    .enter()
                    .append("g")
                    .attr("class", "ridge-group")
                    .attr("transform", d => `translate(0, ${y(d.name) - y.step() * overlap})`);

                ridges.append("path")
                    .attr("class", "ridge-area")
                    .attr("fill", "#dbeafe")
                    .attr("fill-opacity", 0.3)
                    .attr("d", d => area(d.values))
                    .attr("stroke", "none");

                ridges.append("path")
                    .attr("class", "ridge-line")
                    .attr("fill", "none")
                    .attr("stroke", "#3b82f6")
                    .attr("stroke-width", 1)
                    .attr("stroke-opacity", 0.5)
                    .attr("d", d => line(d.values));

                // Add text labels for Desktop
                if (!isMobile) {
                    ridges.append("text")
                        .attr("x", -10)
                        .attr("y", y.step() / 2)
                        .attr("text-anchor", "end")
                        .attr("alignment-baseline", "middle")
                        .attr("fill", "#6b7280")
                        .attr("font-size", "12px")
                        .attr("font-weight", "500")
                        .text(d => d.name);
                }

                ridges.style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100)
                    .style("opacity", 1);

            }, [series, height, margin, containerWidth, containerHeight, isMobile]);

            // D3 Update - Selection
            useEffect(() => {
                if (!svgRef.current) return;
                const svg = d3.select(svgRef.current);

                // Reset all
                svg.selectAll(".ridge-area").classed("active", false).transition().duration(200).attr("fill-opacity", 0.3);
                svg.selectAll(".ridge-line").classed("active", false).transition().duration(200).attr("stroke-width", 1).attr("stroke-opacity", 0.5);
                if (!isMobile) svg.selectAll("text").attr("fill", "#6b7280").attr("font-weight", "500");

                if (selectedNode) {
                    const selectedGroup = svg.selectAll(".ridge-group").filter(d => d.name === selectedNode.name);
                    selectedGroup.select(".ridge-area").classed("active", true).transition().duration(200).attr("fill-opacity", 0.8);
                    selectedGroup.select(".ridge-line").classed("active", true);
                    if (!isMobile) selectedGroup.select("text").attr("fill", "#111827").attr("font-weight", "700");
                }
            }, [selectedNode, isMobile]);

            return (
                <div ref={containerRef} 
                     style={{ position: 'relative', touchAction: 'none' }}
                     onMouseMove={handleDesktopHover}
                     onMouseLeave={() => !isMobile && setSelectedNode(null)}
                >
                    <svg ref={svgRef} style={{ width: '100%', height: 'auto', background: '#ffffff', borderRadius: '12px', marginTop: '1rem' }}></svg>
                    
                    {/* Slider Track - Only on Mobile */}
                    {isMobile && (
                        <div style={{
                            position: 'absolute',
                            left: '16px',
                            top: `${(margin.top / containerHeight) * 100}%`,
                            height: `${(height / containerHeight) * 100}%`,
                            width: '4px',
                            background: '#f3f4f6',
                            borderRadius: '2px'
                        }}>
                            {/* Pill Handle */}
                            <div 
                                onMouseDown={(e) => handleDragStart(e.clientY)}
                                onTouchStart={(e) => handleDragStart(e.touches[0].clientY)}
                                style={{
                                    position: 'absolute',
                                    top: `${(sliderY / height) * 100}%`,
                                    left: '50%',
                                    transform: 'translate(-50%, -50%)',
                                    width: '16px',
                                    height: '32px',
                                    background: '#3b82f6',
                                    borderRadius: '16px',
                                    cursor: 'grab',
                                    boxShadow: '0 2px 5px rgba(0,0,0,0.2)',
                                    border: '2px solid white',
                                    zIndex: 10
                                }}
                            />
                        </div>
                    )}

                    {selectedNode && (
                        <div style={{
                            position: isMobile ? 'relative' : 'absolute',
                            bottom: isMobile ? 'auto' : '20px',
                            left: isMobile ? 'auto' : '50%',
                            transform: isMobile ? 'none' : 'translateX(-50%)',
                            marginTop: isMobile ? '1rem' : '0',
                            background: 'rgba(255, 255, 255, 0.95)',
                            backdropFilter: 'blur(8px)',
                            padding: '1rem 1.5rem',
                            borderRadius: '16px',
                            boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                            border: '1px solid #e5e7eb',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            gap: '0.25rem',
                            minWidth: isMobile ? '100%' : '200px',
                            animation: 'fadeInUp 0.3s ease-out',
                            pointerEvents: 'none'
                        }}>
                            <div style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: '500' }}>{selectedNode.name}</div>
                            <div style={{ fontSize: '1.5rem', color: '#111827', fontWeight: '700' }}>{selectedNode.totalSize}</div>
                            <div style={{ fontSize: '0.75rem', color: '#10b981', display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                                <i className="fa-solid fa-arrow-trend-up"></i> Active
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Hero = ({ device }) => {
            const [showViz, setShowViz] = useState(false);
            const [vizType, setVizType] = useState('tree'); // 'tree' or 'usage'

            const vizData = fileSystemData[device.id] || fileSystemData['macbook'];

            return (
                <div className="hero-card" style={{ flexDirection: 'column', alignItems: 'stretch' }}>
                    <div className="device-info">
                        <div className="device-header">
                            <div>
                                <h1 className="device-title" style={{ fontSize: '1.5rem' }}>{device.name}</h1>
                                <div className="device-meta">Serial: {device.serial} • {device.os}</div>
                            </div>
                            <button
                                className="remote-btn"
                                onClick={() => setShowViz(!showViz)}
                                style={{
                                    background: showViz ? '#e5e7eb' : '#3b82f6',
                                    color: showViz ? '#000000' : '#ffffff',
                                    transition: 'all 0.3s',
                                    borderRadius: '50px',
                                    padding: '0.5rem 1.5rem'
                                }}
                            >
                                <i className={showViz ? 'fa-regular fa-eye-slash' : 'fa-solid fa-diagram-project'}></i>
                                <span>{showViz ? 'Close Visualization' : 'Visualization'}</span>
                            </button>
                        </div>

                        <div className="specs-grid">
                            {device.specs.map((spec, index) => (
                                <div className="spec-item" key={index}>
                                    <h4>{spec.label}</h4>
                                    {spec.label === 'Warranty' ? (
                                        <div className={spec.active ? "warranty-active" : ""} style={{ color: spec.active ? '' : '#ef4444' }}>
                                            {spec.value} {spec.active ? <i className="fa-solid fa-circle-check"></i> : <i className="fa-solid fa-circle-xmark"></i>}
                                        </div>
                                    ) : (
                                        <p>{spec.value}</p>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div style={{
                        maxHeight: showViz ? '1000px' : '0',
                        opacity: showViz ? 1 : 0,
                        overflow: 'hidden',
                        transition: 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                        marginTop: showViz ? '2rem' : '0',
                        borderTop: showViz ? '1px solid #e5e7eb' : '0px solid transparent',
                        paddingTop: showViz ? '1rem' : '0'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h3 style={{ fontSize: '1rem', fontWeight: '600', color: '#111827' }}>
                                <i className={`fa-solid ${vizType === 'tree' ? 'fa-folder-tree' : 'fa-chart-simple'}`} style={{ marginRight: '0.5rem', color: '#6b7280' }}></i>
                                {vizType === 'tree' ? 'File System Structure' : 'Storage Usage Analysis'}
                            </h3>

                            {/* Pill Controller */}
                            <div style={{
                                background: '#e5e7eb', borderRadius: '20px', padding: '4px', display: 'flex', position: 'relative', isolate: 'isolate'
                            }}>
                                {/* Sliding Background */}
                                <div style={{
                                    position: 'absolute',
                                    top: '4px', bottom: '4px',
                                    left: vizType === 'tree' ? '4px' : 'calc(50% + 2px)',
                                    width: 'calc(50% - 6px)',
                                    background: 'white',
                                    borderRadius: '16px',
                                    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                    boxShadow: '0 1px 2px rgba(0,0,0,0.1)',
                                    zIndex: 0
                                }}></div>

                                <button
                                    onClick={() => setVizType('tree')}
                                    style={{
                                        background: 'transparent',
                                        color: vizType === 'tree' ? '#111827' : '#6b7280',
                                        border: 'none', borderRadius: '16px', padding: '4px 12px',
                                        fontSize: '0.8rem', fontWeight: '600', cursor: 'pointer',
                                        width: '60px',
                                        transition: 'color 0.2s',
                                        zIndex: 1,
                                        position: 'relative'
                                    }}
                                >
                                    Tree
                                </button>
                                <button
                                    onClick={() => setVizType('usage')}
                                    style={{
                                        background: 'transparent',
                                        color: vizType === 'usage' ? '#111827' : '#6b7280',
                                        border: 'none', borderRadius: '16px', padding: '4px 12px',
                                        fontSize: '0.8rem', fontWeight: '600', cursor: 'pointer',
                                        width: '60px',
                                        transition: 'color 0.2s',
                                        zIndex: 1,
                                        position: 'relative'
                                    }}
                                >
                                    Usage
                                </button>
                            </div>
                        </div>

                        {vizType === 'tree' ? (
                            <FileTreeViz data={vizData} />
                        ) : (
                            <FileUsageViz data={vizData} />
                        )}
                    </div>
                </div>
            );
        };

        const TabNavigation = ({ activeTab, setActiveTab }) => {
            const tabs = ['Overview', 'Security', 'Performance', 'AI Insights'];
            const [sliderStyle, setSliderStyle] = useState({ left: 4, width: 0 });
            const tabsRef = useRef([]);

            const getIconClass = (tab) => {
                switch (tab) {
                    case 'Overview': return 'fa-solid fa-border-all';
                    case 'Security': return 'fa-solid fa-shield-halved';
                    case 'Performance': return 'fa-solid fa-gauge-high';
                    case 'AI Insights': return 'fa-solid fa-wand-magic-sparkles';
                    default: return '';
                }
            };

            useEffect(() => {
                const updateSlider = () => {
                    const activeIndex = tabs.indexOf(activeTab);
                    const currentTab = tabsRef.current[activeIndex];
                    if (currentTab) {
                        setSliderStyle({
                            left: currentTab.offsetLeft,
                            width: currentTab.offsetWidth
                        });
                    }
                };

                updateSlider();
                window.addEventListener('resize', updateSlider);
                return () => window.removeEventListener('resize', updateSlider);
            }, [activeTab]);

            return (
                <div className="tabs" style={{ position: 'relative', isolate: 'isolate', display: 'flex', gap: '0.5rem', background: '#e5e7eb', padding: '0.25rem', borderRadius: '50px', width: '100%', marginBottom: '2rem' }}>
                    <div style={{
                        position: 'absolute',
                        top: '4px', bottom: '4px',
                        left: sliderStyle.left,
                        width: sliderStyle.width,
                        background: 'white',
                        borderRadius: '50px',
                        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        boxShadow: '0 1px 2px rgba(0,0,0,0.1)',
                        zIndex: 0
                    }}></div>
                    {tabs.map((tab, index) => (
                        <button
                            key={tab}
                            ref={el => tabsRef.current[index] = el}
                            className={`tab ${activeTab === tab ? 'active' : ''}`}
                            onClick={() => setActiveTab(tab)}
                            style={{
                                position: 'relative',
                                zIndex: 1,
                                background: 'transparent',
                                border: 'none',
                                color: activeTab === tab ? '#111827' : '#6b7280',
                                transition: 'color 0.2s',
                                cursor: 'pointer',
                                padding: '0.5rem 0',
                                borderRadius: '50px',
                                fontSize: '0.875rem',
                                fontWeight: '500',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '0.5rem'
                            }}
                        >
                            <i className={getIconClass(tab)}></i>
                            <span className="tab-text">{tab}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const StatusSelector = ({ initialStatus, onStatusChange, optimizingLoading, monitoringLoading }) => {
            // Removed local state to make it a fully controlled component
            // This prevents state desync issues where the selector might revert the parent's status

            const options = [
                { label: 'Online - Idle', color: '#10b981', type: 'online' },
                { label: 'Ai - Monitoring', color: monitoringLoading ? '#f97316' : '#3b82f6', type: 'ai' },
                { label: 'Offline', color: '#9ca3af', type: 'offline' }
            ];

            // If current status is Data Optimizing or Setup (programmatically set), add it to options temporarily or handle display
            const currentOption = options.find(o => initialStatus === o.label) ||
                (initialStatus === 'Ai - Data Optimizing' ? { label: 'Ai - Data Optimizing', color: optimizingLoading ? '#f97316' : '#3b82f6', type: 'ai' } : null) ||
                (initialStatus === 'Ai - Setup' ? { label: 'Ai - Setup', color: '#3b82f6', type: 'ai' } : null) ||
                options.find(o => initialStatus.includes(o.type === 'ai' ? 'Ai' : o.type === 'online' ? 'Online' : 'Offline')) ||
                options[0];

            const handleStatusChange = (newStatus) => {
                if (onStatusChange) onStatusChange(newStatus);
            };

            const getAnimation = (label, color) => {
                if (label === 'Ai - Data Optimizing') {
                    return optimizingLoading ? 'pulse-ring-orange 2s infinite' : 'pulse-ring 2s infinite';
                }
                if (label === 'Ai - Monitoring' && monitoringLoading) {
                    return 'pulse-ring-orange 2s infinite';
                }
                return 'none';
            };

            const getBoxShadow = (label, color) => {
                if (label === 'Ai - Data Optimizing') {
                    return `0 0 0 0 ${color}`;
                }
                if (label === 'Ai - Monitoring' && monitoringLoading) {
                    return `0 0 0 0 ${color}`;
                }
                return 'none';
            };

            return (
                <div className="status-badge" style={{ position: 'relative', cursor: 'pointer' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                        <div className="status-dot" style={{
                            backgroundColor: currentOption.color,
                            boxShadow: getBoxShadow(currentOption.label, currentOption.color),
                            animation: getAnimation(currentOption.label, currentOption.color)
                        }}></div>
                        {currentOption.label}
                        <i className="fa-solid fa-chevron-down" style={{ fontSize: '0.7rem', marginLeft: '0.25rem', color: '#9ca3af' }}></i>
                    </div>

                    <div className="status-dropdown">
                        {options.map(opt => (
                            <div
                                key={opt.label}
                                className="status-option"
                                onClick={() => handleStatusChange(opt.label)}
                            >
                                <div className="status-dot" style={{
                                    backgroundColor: opt.color,
                                    boxShadow: getBoxShadow(opt.label, opt.color),
                                    animation: getAnimation(opt.label, opt.color)
                                }}></div>
                                {opt.label}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AiMonitoringView = ({ onActivate, items, currentItemId, type = 'device', onLoadingStateChange, isInitialized, onInitialized, skipAnimation }) => {
            const [logs, setLogs] = useState([]);
            const [loadingStep, setLoadingStep] = useState(0);
            const logContainerRef = useRef(null);

            const loadingSteps = [
                { msg: "Initializing Agent...", duration: 800 },
                { msg: "Connecting to Neural Grid...", duration: 1000 },
                { msg: "Verifying Security Protocols...", duration: 600 },
                { msg: "Establishing Secure Link...", duration: 800 }
            ];

            useEffect(() => {
                if (isInitialized || skipAnimation) {
                    setLoadingStep(loadingSteps.length + 1);
                    if (skipAnimation && onLoadingStateChange) onLoadingStateChange(false);
                    if (skipAnimation && onInitialized) onInitialized(true);
                    return;
                }

                if (onLoadingStateChange) onLoadingStateChange(true);
                let currentStep = 0;
                
                const runStep = () => {
                    if (currentStep >= loadingSteps.length) {
                        setLoadingStep(loadingSteps.length + 1); // Done
                        if (onLoadingStateChange) onLoadingStateChange(false);
                        if (onInitialized) onInitialized(true);
                        return;
                    }
                    
                    setLoadingStep(currentStep + 1);
                    setTimeout(() => {
                        currentStep++;
                        runStep();
                    }, loadingSteps[currentStep].duration);
                };

                runStep();

                return () => {
                    if (onLoadingStateChange) onLoadingStateChange(false);
                };
            }, []);

            useEffect(() => {
                if (logContainerRef.current) {
                    logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;
                }
            }, [logs]);

            useEffect(() => {
                if (loadingStep <= loadingSteps.length) return;

                const deviceMessages = [
                    "Initializing AI Neural Engine...",
                    "Scanning local network topology...",
                    "Analyzing storage patterns...",
                    "Checking device latency...",
                    "Optimization opportunities detected.",
                    "Monitoring active connections...",
                    "Verifying data integrity...",
                    "Calculating optimal transfer paths...",
                    "Syncing index with master node...",
                    "Detecting low-priority assets...",
                    "Analyzing read/write IOPS...",
                    "Checking thermal status...",
                    "Validating encryption keys...",
                    "Scanning for duplicate shards...",
                    "Network throughput stable.",
                    "Re-evaluating storage tiering...",
                    "Compressing idle log files...",
                    "Updating heuristic models...",
                    "Ping check: 12ms - Stable",
                    "Ping check: 15ms - Stable"
                ];

                const cloudMessages = [
                    "Connecting to Cloud API Gateway...",
                    "Analyzing bucket usage patterns...",
                    "Checking API rate limits...",
                    "Monitoring lambda function execution...",
                    "Optimization opportunities detected in S3...",
                    "Verifying VPC security groups...",
                    "Calculating data transfer costs...",
                    "Syncing region availability zones...",
                    "Detecting unattached volumes...",
                    "Analyzing database IOPS...",
                    "Checking load balancer health...",
                    "Validating SSL certificates...",
                    "Scanning for open ports...",
                    "Network latency stable.",
                    "Re-evaluating instance sizing...",
                    "Compressing log streams...",
                    "Updating auto-scaling policies...",
                    "Ping check: 45ms - Stable",
                    "Ping check: 42ms - Stable"
                ];

                const messages = type === 'cloud' ? cloudMessages : deviceMessages;

                const interval = setInterval(() => {
                    const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                    setLogs(prev => {
                        const newLogs = [...prev, { time: new Date().toLocaleTimeString(), msg: randomMsg }];
                        if (newLogs.length > 50) return newLogs.slice(1);
                        return newLogs;
                    });
                }, 800);

                return () => clearInterval(interval);
            }, [loadingStep, type]);

            if (loadingStep <= loadingSteps.length) {
                const stepData = loadingSteps[loadingStep - 1] || loadingSteps[0];
                return (
                    <div className="ai-monitoring-container" style={{ justifyContent: 'center' }}>
                        <div style={{ marginBottom: '2rem', fontSize: '3rem', color: '#3b82f6' }}>
                            <i className="fa-solid fa-circle-notch fa-spin"></i>
                        </div>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: '600', marginBottom: '1rem', color: '#111827' }}>
                            {stepData.msg}
                        </h2>
                        <div style={{ color: '#6b7280', fontSize: '1rem', marginBottom: '1.5rem' }}>
                            Step {loadingStep}/{loadingSteps.length}
                        </div>
                        <div style={{ 
                            width: '200px', height: '4px', background: '#e5e7eb', borderRadius: '2px', 
                            overflow: 'hidden' 
                        }}>
                            <div style={{ 
                                width: `${(loadingStep / loadingSteps.length) * 100}%`, 
                                height: '100%', background: '#3b82f6', transition: 'width 0.5s ease' 
                            }}></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="ai-monitoring-container">
                    <h2 style={{ fontSize: '1.75rem', fontWeight: '700', marginBottom: '1rem', color: '#111827' }}>
                        Agentic System Monitoring
                    </h2>

                    <div className="no-scrollbar" ref={logContainerRef} style={{
                        background: '#f3f4f6', color: '#374151', padding: '1.5rem', borderRadius: '12px',
                        width: '100%', fontSize: '0.9rem', textAlign: 'left',
                        marginBottom: '2rem', height: '150px', overflowY: 'auto'
                    }}>
                        {logs.map((log, i) => (
                            <div key={i} style={{ marginBottom: '0.5rem' }}>
                                <span style={{ color: '#6b7280', marginRight: '0.5rem' }}>[{log.time}]</span>
                                {log.msg}
                            </div>
                        ))}
                    </div>

                    <p style={{ color: '#6b7280', marginBottom: '2rem', lineHeight: '1.6' }}>
                        AI has detected that this {type === 'cloud' ? 'cloud service' : 'device'} can serve as a <strong>Master Control Hub</strong> to optimize storage across your network.
                        Enable this feature to allow autonomous file management.
                    </p>

                    <button
                        onClick={onActivate}
                        style={{
                            background: '#3b82f6', color: 'white', border: 'none', padding: '1rem 2rem',
                            borderRadius: '50px', fontSize: '1rem', fontWeight: '600', cursor: 'pointer',
                            display: 'flex', alignItems: 'center', gap: '0.5rem',
                            boxShadow: '0 4px 6px -1px rgba(59, 130, 246, 0.5)',
                            transition: 'transform 0.2s'
                        }}
                        onMouseOver={e => e.currentTarget.style.transform = 'scale(1.05)'}
                        onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}
                    >
                        <i className="fa-solid fa-gear"></i> Activate Master Control
                    </button>
                </div>
            );
        };

        const AiMasterControlSetupView = ({ onConfirm, onCancel, items, currentItemId, type = 'device' }) => {
            const otherItems = items.filter(d => d.id !== currentItemId);

            return (
                <div className="master-access-container">
                    <h2 style={{ fontSize: '2rem', fontWeight: '800', marginBottom: '0.5rem', color: '#1e293b', letterSpacing: '-0.025em' }}>
                        Grant Master Access
                    </h2>
                    <p style={{ color: '#64748b', fontSize: '1.1rem', lineHeight: '1.6', marginBottom: '1.5rem', maxWidth: '480px' }}>
                        Authorize this {type === 'cloud' ? 'service' : 'device'} to autonomously manage and optimize storage across your network.
                    </p>

                    <div style={{
                        width: '100%', maxWidth: '480px',
                        background: 'white', borderRadius: '20px',
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        padding: '1.5rem', marginBottom: '1.5rem', border: '1px solid #f1f5f9'
                    }}>
                        <div style={{
                            display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                            fontSize: '0.75rem', fontWeight: '700', color: '#94a3b8', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: '1rem'
                        }}>
                            <span>Target {type === 'cloud' ? 'Services' : 'Devices'}</span>
                            <span>{otherItems.length} Connected</span>
                        </div>
                        <div style={{
                            display: 'flex', flexDirection: 'column', gap: '0.5rem',
                            maxHeight: '240px', overflowY: 'auto', paddingRight: '0.25rem'
                        }}>
                            {otherItems.map(d => (
                                <div key={d.id} className="device-list-item" style={{
                                    display: 'flex', alignItems: 'center', gap: '1rem',
                                    padding: '0.75rem 1rem', borderRadius: '12px',
                                    background: '#f8fafc', border: '1px solid #f1f5f9'
                                }}>
                                    <div className="device-icon-box" style={{
                                        width: '40px', height: '40px', borderRadius: '10px', background: 'white',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#64748b',
                                        boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                                    }}>
                                        <i className={d.icon ? (d.icon.includes(' ') ? d.icon : `fa-solid ${d.icon}`) : 'fa-solid fa-circle'} style={{ fontSize: '1.1rem' }}></i>
                                    </div>
                                    <span className="device-name" style={{ fontSize: '1rem', fontWeight: '600', color: '#334155' }}>{d.name}</span>
                                    <div className="device-check-box" style={{ marginLeft: 'auto', width: '24px', height: '24px', borderRadius: '50%', background: '#dcfce7', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                        <i className="fa-solid fa-check" style={{ color: '#16a34a', fontSize: '0.8rem' }}></i>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div style={{
                        display: 'flex', gap: '0.75rem', padding: '1rem', background: '#fff7ed',
                        borderRadius: '12px', marginBottom: '1.5rem', alignItems: 'flex-start', maxWidth: '480px', width: '100%'
                    }}>
                        <i className="fa-solid fa-circle-info" style={{ color: '#ea580c', marginTop: '0.2rem' }}></i>
                        <p style={{ fontSize: '0.9rem', color: '#9a3412', margin: 0, lineHeight: '1.5', textAlign: 'left' }}>
                            <strong>Note:</strong> This process is resource-intensive. We recommend running it during inactive hours.
                        </p>
                    </div>

                    <div style={{ display: 'flex', gap: '1rem', width: '100%', maxWidth: '480px' }}>
                        <button
                            onClick={onCancel}
                            style={{
                                flex: 1, padding: '1.25rem', borderRadius: '16px', border: 'none',
                                background: '#f1f5f9', color: '#64748b', fontWeight: '600', cursor: 'pointer',
                                transition: 'all 0.2s', fontSize: '1rem'
                            }}
                            onMouseOver={e => { e.currentTarget.style.background = '#e2e8f0'; }}
                            onMouseOut={e => { e.currentTarget.style.background = '#f1f5f9'; }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={onConfirm}
                            style={{
                                flex: 1.5, padding: '1.25rem', borderRadius: '16px', border: 'none',
                                background: '#111827',
                                color: 'white', fontWeight: '600', cursor: 'pointer',
                                boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                                transition: 'transform 0.2s', fontSize: '1rem'
                            }}
                            onMouseOver={e => e.currentTarget.style.transform = 'scale(1.02)'}
                            onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            Authorize Access
                        </button>
                    </div>
                </div>
            );
        };

        const AiOptimizationProcessView = ({ onLoadingStateChange, isInitialized, onInitialized, skipAnimation, type = 'device' }) => {
            const [currentScenarioIndex, setCurrentScenarioIndex] = useState(0);
            const [logs, setLogs] = useState([]);
            const [progress, setProgress] = useState(0);
            const [loadingStep, setLoadingStep] = useState(0);
            const logContainerRef = useRef(null);

            const loadingSteps = [
                { msg: "Assessing Data Structure...", duration: 800 },
                { msg: "Calculating Compression Ratios...", duration: 1000 },
                { msg: "Allocating Processing Power...", duration: 600 },
                { msg: "Initializing Optimization Protocols...", duration: 800 }
            ];

            useEffect(() => {
                if (isInitialized || skipAnimation) {
                    setLoadingStep(loadingSteps.length + 1);
                    if (skipAnimation && onLoadingStateChange) onLoadingStateChange(false);
                    if (skipAnimation && onInitialized) onInitialized(true);
                    return;
                }

                if (onLoadingStateChange) onLoadingStateChange(true);
                let currentStep = 0;
                
                const runStep = () => {
                    if (currentStep >= loadingSteps.length) {
                        setLoadingStep(loadingSteps.length + 1); // Done
                        if (onLoadingStateChange) onLoadingStateChange(false);
                        if (onInitialized) onInitialized(true);
                        return;
                    }
                    
                    setLoadingStep(currentStep + 1);
                    setTimeout(() => {
                        currentStep++;
                        runStep();
                    }, loadingSteps[currentStep].duration);
                };

                runStep();
                
                return () => {
                    if (onLoadingStateChange) onLoadingStateChange(false);
                };
            }, []);

            useEffect(() => {
                if (logContainerRef.current) {
                    logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;
                }
            }, [logs]);

            const scenarios = type === 'cloud' ? [
                "Analyzing API request patterns for latency reduction...",
                "Compressing static assets in S3 buckets...",
                "Optimizing database read replicas...",
                "Moving infrequent access data to Glacier...",
                "Rotating API keys and updating security policies...",
                "Scaling auto-scaling groups based on load...",
                "Cleaning up unused EBS volumes...",
                "Caching frequent queries in Redis...",
                "Synchronizing CDN edge locations...",
                "Verifying IAM role permissions..."
            ] : [
                "Analyzing redundant cache files in /var/log...",
                "Compressing old media assets (HEVC conversion)...",
                "Re-indexing database shards for faster query performance...",
                "Moving cold storage data to Glacier tier...",
                "Encrypting sensitive user payloads (AES-256)...",
                "Optimizing neural network weights for local inference...",
                "Cleaning up orphaned docker containers...",
                "Defragmenting high-frequency storage sectors...",
                "Synchronizing distributed ledger nodes...",
                "Verifying integrity of backup snapshots..."
            ];

            useEffect(() => {
                if (loadingStep <= loadingSteps.length) return;

                let scenarioInterval;
                let progressInterval;

                // Scenario rotation
                scenarioInterval = setInterval(() => {
                    setCurrentScenarioIndex(prev => (prev + 1) % scenarios.length);
                    setProgress(0);
                    setLogs(prev => {
                        const newLogs = [...prev, {
                            time: new Date().toLocaleTimeString(),
                            msg: `Completed: ${scenarios[currentScenarioIndex]}`
                        }];
                        // if (newLogs.length > 6) newLogs.shift(); // Keep all logs to show scrolling
                        return newLogs;
                    });
                }, 4000);

                // Progress bar animation
                progressInterval = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 100) return 100;
                        return prev + 2; // 50 steps * 80ms = 4000ms approx
                    });
                }, 80);

                return () => {
                    clearInterval(scenarioInterval);
                    clearInterval(progressInterval);
                };
            }, [currentScenarioIndex, loadingStep]);

            if (loadingStep <= loadingSteps.length) {
                const stepData = loadingSteps[loadingStep - 1] || loadingSteps[0];
                return (
                    <div className="ai-optimization-container" style={{ justifyContent: 'center' }}>
                        <div style={{ marginBottom: '2rem', fontSize: '3rem', color: '#3b82f6' }}>
                            <i className="fa-solid fa-gear fa-spin"></i>
                        </div>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: '600', marginBottom: '1rem', color: '#111827' }}>
                            {stepData.msg}
                        </h2>
                        <div style={{ color: '#6b7280', fontSize: '1rem', marginBottom: '1.5rem' }}>
                            Step {loadingStep}/{loadingSteps.length}
                        </div>
                        <div style={{ 
                            width: '200px', height: '4px', background: '#e5e7eb', borderRadius: '2px', 
                            overflow: 'hidden' 
                        }}>
                            <div style={{ 
                                width: `${(loadingStep / loadingSteps.length) * 100}%`, 
                                height: '100%', background: '#3b82f6', transition: 'width 0.5s ease' 
                            }}></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="ai-optimization-container">
                    <h2 className="ai-optimization-title">
                        Agentic Optimization in Progress
                    </h2>
                    <p style={{ color: '#6b7280', marginBottom: '3rem' }}>
                        Master Control is autonomously managing your data ecosystem.
                    </p>

                    <div style={{ width: '100%', maxWidth: '600px', marginBottom: '2rem' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem', fontSize: '0.9rem', color: '#374151', fontWeight: '600' }}>
                            <span>Current Task</span>
                            <span>{progress}%</span>
                        </div>
                        <div style={{
                            width: '100%', height: '12px', background: '#e5e7eb', borderRadius: '6px', overflow: 'hidden'
                        }}>
                            <div style={{
                                width: `${progress}%`, height: '100%', background: '#3b82f6',
                                transition: 'width 0.1s linear'
                            }}></div>
                        </div>
                        <div style={{ textAlign: 'left', marginTop: '0.5rem', color: '#3b82f6', fontSize: '0.9rem' }}>
                            <i className="fa-solid fa-terminal" style={{ marginRight: '0.5rem' }}></i>
                            {scenarios[currentScenarioIndex]}
                        </div>
                    </div>

                    <div className="no-scrollbar" ref={logContainerRef} style={{
                        background: '#f3f4f6', color: '#374151', padding: '1.5rem', borderRadius: '12px',
                        width: '100%', maxWidth: '600px', textAlign: 'left', height: '200px', overflowY: 'auto',
                        position: 'relative', fontSize: '0.85rem', lineHeight: '1.6'
                    }}>
                        <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'flex-end', minHeight: '100%' }}>
                            {logs.map((log, i) => (
                                <div key={i}>
                                    <span style={{ color: '#6b7280', marginRight: '1rem' }}>[{log.time}]</span>
                                    {log.msg}
                                </div>
                            ))}
                            <div>
                                <span style={{ color: '#6b7280', marginRight: '1rem' }}>[{new Date().toLocaleTimeString()}]</span>
                                {scenarios[currentScenarioIndex]} <span className="blink">_</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CardDetailModal = ({ card, onClose }) => {
            if (!card) return null;

            const renderContent = () => {
                switch(card.type) {
                    case 'health':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                <div style={{ padding: '1rem', background: '#f0fdf4', borderRadius: '12px', border: '1px solid #bbf7d0' }}>
                                    <div style={{ fontWeight: 600, color: '#166534', marginBottom: '0.5rem' }}>SMART Status: Passed</div>
                                    <div style={{ fontSize: '0.9rem', color: '#15803d' }}>Your disk is healthy and functioning normally. No errors detected.</div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                    <div style={{ padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                        <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Power On Hours</div>
                                        <div style={{ fontSize: '1.1rem', fontWeight: 600 }}>12,450 hrs</div>
                                    </div>
                                    <div style={{ padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                        <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Temperature</div>
                                        <div style={{ fontSize: '1.1rem', fontWeight: 600 }}>32°C</div>
                                    </div>
                                    <div style={{ padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                        <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Read Errors</div>
                                        <div style={{ fontSize: '1.1rem', fontWeight: 600 }}>0</div>
                                    </div>
                                    <div style={{ padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                        <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Write Errors</div>
                                        <div style={{ fontSize: '1.1rem', fontWeight: 600 }}>0</div>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'storage':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#3b82f6' }}></div>
                                        <span style={{ fontWeight: 500 }}>System Data</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>124.5 GB</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#10b981' }}></div>
                                        <span style={{ fontWeight: 500 }}>Documents</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>85.2 GB</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#f59e0b' }}></div>
                                        <span style={{ fontWeight: 500 }}>Apps</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>64.8 GB</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#ef4444' }}></div>
                                        <span style={{ fontWeight: 500 }}>Media</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>73.1 GB</span>
                                </div>
                            </div>
                        );
                    case 'api':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                <div style={{ padding: '1rem', background: '#f0fdf4', borderRadius: '12px', border: '1px solid #bbf7d0', marginBottom: '0.5rem' }}>
                                    <div style={{ fontWeight: 600, color: '#166534', marginBottom: '0.5rem' }}>API Health: Excellent</div>
                                    <div style={{ fontSize: '0.9rem', color: '#15803d' }}>All endpoints are responding within expected latency limits.</div>
                                </div>
                                {[
                                    { endpoint: '/v1/users', method: 'GET', latency: '45ms', status: '200 OK' },
                                    { endpoint: '/v1/auth', method: 'POST', latency: '120ms', status: '200 OK' },
                                    { endpoint: '/v1/data', method: 'GET', latency: '85ms', status: '200 OK' },
                                    { endpoint: '/v1/sync', method: 'POST', latency: '210ms', status: '200 OK' },
                                    { endpoint: '/v1/status', method: 'GET', latency: '20ms', status: '200 OK' }
                                ].map((item, i) => (
                                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', borderBottom: '1px solid #f3f4f6' }}>
                                        <div>
                                            <div style={{ fontWeight: 500, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <span style={{ fontSize: '0.7rem', padding: '2px 6px', borderRadius: '4px', background: item.method === 'GET' ? '#dbeafe' : '#fce7f3', color: item.method === 'GET' ? '#1e40af' : '#9d174d' }}>{item.method}</span>
                                                {item.endpoint}
                                            </div>
                                        </div>
                                        <div style={{ textAlign: 'right' }}>
                                            <div style={{ fontWeight: 600 }}>{item.latency}</div>
                                            <div style={{ fontSize: '0.8rem', color: '#16a34a' }}>{item.status}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        );
                    case 'cost':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#3b82f6' }}></div>
                                        <span style={{ fontWeight: 500 }}>Compute Instances</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>$24.50</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#10b981' }}></div>
                                        <span style={{ fontWeight: 500 }}>Storage</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>$12.80</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#f59e0b' }}></div>
                                        <span style={{ fontWeight: 500 }}>Data Transfer</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>$5.40</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#ef4444' }}></div>
                                        <span style={{ fontWeight: 500 }}>Other Services</span>
                                    </div>
                                    <span style={{ fontWeight: 600 }}>$2.50</span>
                                </div>
                                <div style={{ marginTop: '1rem', padding: '1rem', background: '#f3f4f6', borderRadius: '12px', textAlign: 'center' }}>
                                    <div style={{ fontSize: '0.9rem', color: '#6b7280' }}>Total Estimated Cost</div>
                                    <div style={{ fontSize: '1.5rem', fontWeight: 700, color: '#111827' }}>$45.20</div>
                                </div>
                            </div>
                        );
                    case 'backup':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                {[
                                    { date: 'Today, 09:41 AM', size: '1.2 GB', status: 'Success' },
                                    { date: 'Yesterday, 09:00 AM', size: '0.8 GB', status: 'Success' },
                                    { date: 'Oct 24, 09:00 AM', size: '1.5 GB', status: 'Success' },
                                    { date: 'Oct 23, 09:00 AM', size: '4.2 GB', status: 'Success' },
                                    { date: 'Oct 22, 09:00 AM', size: '0.5 GB', status: 'Success' }
                                ].map((item, i) => (
                                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', borderBottom: '1px solid #f3f4f6' }}>
                                        <div>
                                            <div style={{ fontWeight: 500 }}>Incremental Backup</div>
                                            <div style={{ fontSize: '0.8rem', color: '#9ca3af' }}>{item.date}</div>
                                        </div>
                                        <div style={{ textAlign: 'right' }}>
                                            <div style={{ fontWeight: 600 }}>{item.size}</div>
                                            <div style={{ fontSize: '0.8rem', color: '#16a34a' }}>{item.status}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        );
                    case 'security':
                    case 'security_score':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                {[
                                    { label: 'Firewall', status: 'Active', color: '#16a34a' },
                                    { label: 'FileVault', status: 'Encrypted', color: '#16a34a' },
                                    { label: 'Gatekeeper', status: 'Enabled', color: '#16a34a' },
                                    { label: 'Stealth Mode', status: 'Disabled', color: '#dc2626' },
                                    { label: 'Auto Update', status: 'On', color: '#16a34a' }
                                ].map((item, i) => (
                                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', borderBottom: '1px solid #f3f4f6' }}>
                                        <span style={{ fontWeight: 500 }}>{item.label}</span>
                                        <span style={{ color: item.color, fontWeight: 600 }}>{item.status}</span>
                                    </div>
                                ))}
                            </div>
                        );
                    case 'encryption':
                        return (
                            <div style={{ padding: '1rem', background: '#eff6ff', borderRadius: '12px', border: '1px solid #bfdbfe' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem' }}>
                                    <i className="fa-solid fa-lock" style={{ color: '#2563eb', fontSize: '1.5rem' }}></i>
                                    <div>
                                        <div style={{ fontWeight: 600, color: '#1e40af' }}>AES-256 Encryption</div>
                                        <div style={{ fontSize: '0.9rem', color: '#1e3a8a' }}>Military-grade protection</div>
                                    </div>
                                </div>
                                <p style={{ fontSize: '0.9rem', color: '#3b82f6', lineHeight: '1.5' }}>
                                    Your data is encrypted at rest using XTS-AES-128 encryption with a 256-bit key. This ensures that your data is inaccessible to unauthorized users, even if the physical drive is removed.
                                </p>
                            </div>
                        );
                    case 'threats':
                        return (
                            <div style={{ textAlign: 'center', padding: '2rem 0' }}>
                                <div style={{ width: '64px', height: '64px', background: '#ecfdf5', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 1rem', color: '#10b981', fontSize: '2rem' }}>
                                    <i className="fa-solid fa-check"></i>
                                </div>
                                <h3 style={{ fontSize: '1.25rem', fontWeight: 600, marginBottom: '0.5rem' }}>No Threats Detected</h3>
                                <p style={{ color: '#6b7280' }}>Your system is clean. Last scan completed 10 minutes ago.</p>
                            </div>
                        );
                    case 'audit':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: isMobile ? '1rem' : '0.75rem' }}>
                                {[
                                    { action: 'System Login', user: 'Admin', time: '10 mins ago', icon: 'fa-user' },
                                    { action: 'Firewall Rules Updated', user: 'System', time: '2 hours ago', icon: 'fa-shield-halved' },
                                    { action: 'Software Update Installed', user: 'System', time: 'Yesterday', icon: 'fa-download' },
                                    { action: 'Password Changed', user: 'Admin', time: '3 days ago', icon: 'fa-key' },
                                    { action: 'New Device Connected', user: 'System', time: '5 days ago', icon: 'fa-link' }
                                ].map((item, i) => (
                                    <div key={i} style={{ 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: '1rem', 
                                        padding: isMobile ? '1rem' : '0.75rem', 
                                        borderBottom: isMobile ? 'none' : '1px solid #f3f4f6',
                                        background: isMobile ? '#f9fafb' : 'transparent',
                                        borderRadius: isMobile ? '12px' : '0'
                                    }}>
                                        <div style={{ 
                                            width: isMobile ? '40px' : '32px', 
                                            height: isMobile ? '40px' : '32px', 
                                            background: isMobile ? '#ffffff' : '#f3f4f6', 
                                            borderRadius: '8px', 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            justifyContent: 'center', 
                                            color: '#6b7280',
                                            flexShrink: 0,
                                            boxShadow: isMobile ? '0 1px 2px rgba(0,0,0,0.05)' : 'none'
                                        }}>
                                            <i className={`fa-solid ${item.icon}`} style={{ fontSize: isMobile ? '1.1rem' : '0.9rem' }}></i>
                                        </div>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{ fontWeight: 600, fontSize: isMobile ? '0.95rem' : '1rem', marginBottom: isMobile ? '0.25rem' : '0', color: '#1f2937' }}>{item.action}</div>
                                            <div style={{ fontSize: '0.8rem', color: '#6b7280', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <span style={{ background: isMobile ? '#e5e7eb' : 'transparent', padding: isMobile ? '2px 8px' : '0', borderRadius: '4px', fontSize: '0.75rem', fontWeight: isMobile ? '600' : '400', color: isMobile ? '#374151' : '#6b7280' }}>
                                                    {item.user}
                                                </span>
                                                <span style={{ width: '3px', height: '3px', background: '#9ca3af', borderRadius: '50%', display: isMobile ? 'none' : 'block' }}></span>
                                                <span>{item.time}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        );
                    case 'uptime':
                        return (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                <div style={{ padding: '1rem', background: '#fff7ed', borderRadius: '12px', gridColumn: '1 / -1', textAlign: 'center' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#9a3412', marginBottom: '0.25rem' }}>Current Session</div>
                                    <div style={{ fontSize: '2rem', fontWeight: '700', color: '#c2410c' }}>14d 2h 15m</div>
                                </div>
                                <div style={{ padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Last Reboot</div>
                                    <div style={{ fontWeight: 600 }}>Oct 12</div>
                                </div>
                                <div style={{ padding: '1rem', background: '#f9fafb', borderRadius: '12px' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>Availability</div>
                                    <div style={{ fontWeight: 600 }}>99.9%</div>
                                </div>
                            </div>
                        );
                    case 'temperature':
                        return (
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                {[
                                    { label: 'CPU Core 1', temp: '42°C' },
                                    { label: 'CPU Core 2', temp: '44°C' },
                                    { label: 'CPU Core 3', temp: '41°C' },
                                    { label: 'CPU Core 4', temp: '43°C' },
                                    { label: 'GPU Die', temp: '48°C' },
                                    { label: 'Battery', temp: '32°C' },
                                    { label: 'SSD Controller', temp: '38°C' },
                                    { label: 'Palm Rest', temp: '28°C' }
                                ].map((sensor, i) => (
                                    <div key={i} style={{ padding: '1rem', background: '#f9fafb', borderRadius: '12px', display: 'flex', justifyContent: 'space-between' }}>
                                        <span style={{ color: '#6b7280', fontSize: '0.875rem' }}>{sensor.label}</span>
                                        <span style={{ fontWeight: 600 }}>{sensor.temp}</span>
                                    </div>
                                ))}
                            </div>
                        );
                    case 'processes':
                    case 'topApps':
                        return (
                            <div style={{ display: 'flex', flexDirection: 'column' }}>
                                <div style={{ display: 'flex', padding: '0.5rem', borderBottom: '2px solid #f3f4f6', fontWeight: 600, fontSize: '0.875rem', color: '#6b7280' }}>
                                    <span style={{ flex: 2 }}>Process Name</span>
                                    <span style={{ flex: 1, textAlign: 'right' }}>CPU</span>
                                    <span style={{ flex: 1, textAlign: 'right' }}>Mem</span>
                                </div>
                                {[
                                    { name: 'kernel_task', cpu: '4.2%', mem: '1.2 GB' },
                                    { name: 'WindowServer', cpu: '3.1%', mem: '850 MB' },
                                    { name: 'Google Chrome', cpu: '2.5%', mem: '2.1 GB' },
                                    { name: 'Code Helper', cpu: '1.8%', mem: '450 MB' },
                                    { name: 'Slack Helper', cpu: '0.5%', mem: '320 MB' },
                                    { name: 'Spotify', cpu: '0.3%', mem: '280 MB' },
                                    { name: 'Finder', cpu: '0.1%', mem: '120 MB' },
                                    { name: 'Dock', cpu: '0.1%', mem: '85 MB' }
                                ].map((proc, i) => (
                                    <div key={i} style={{ display: 'flex', padding: '0.75rem 0.5rem', borderBottom: '1px solid #f3f4f6', fontSize: '0.9rem' }}>
                                        <span style={{ flex: 2, fontWeight: 500 }}>{proc.name}</span>
                                        <span style={{ flex: 1, textAlign: 'right' }}>{proc.cpu}</span>
                                        <span style={{ flex: 1, textAlign: 'right' }}>{proc.mem}</span>
                                    </div>
                                ))}
                            </div>
                        );
                    default:
                        return <div style={{ color: '#6b7280', textAlign: 'center', padding: '2rem' }}>Detailed analysis not available for this item.</div>;
                }
            };

            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    backgroundColor: 'rgba(255,255,255,0.05)', zIndex: 1000,
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    backdropFilter: 'blur(8px)'
                }} onClick={onClose}>
                    <div style={{
                        backgroundColor: 'white', borderRadius: '24px', padding: '2rem',
                        width: '90%', maxWidth: '500px', position: 'relative',
                        boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        animation: 'fadeInUp 0.3s ease-out'
                    }} onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} style={{
                            position: 'absolute', top: '1.5rem', right: '1.5rem',
                            background: 'none', border: 'none', fontSize: '1.25rem',
                            color: '#9ca3af', cursor: 'pointer'
                        }}>
                            <i className="fa-solid fa-xmark"></i>
                        </button>
                        
                        <div style={{ marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '1rem' }}>
                            <div style={{
                                width: '48px', height: '48px', borderRadius: '12px',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: '1.5rem',
                                backgroundColor: card.iconBg || '#f3f4f6',
                                color: card.iconColor || '#4b5563'
                            }}>
                                <i className={`fa-solid ${card.icon}`}></i>
                            </div>
                            <div>
                                <h3 style={{ fontSize: '1.25rem', fontWeight: '700', color: '#111827', margin: 0 }}>{card.title}</h3>
                                <p style={{ fontSize: '0.875rem', color: '#6b7280', margin: 0 }}>Detailed Analysis</p>
                            </div>
                        </div>

                        <div style={{ maxHeight: '60vh', overflowY: 'auto' }}>
                            {renderContent()}
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ selectedDeviceId, devices, onUpdateStatus, setOptimizingLoading, optimizingLoading, setMonitoringLoading, monitoringLoading, isOptimizingInitialized, onOptimizingInitialized, isMonitoringInitialized, onMonitoringInitialized }) => {
            const [activeTab, setActiveTab] = useState('Overview');
            const device = devices.find(d => d.id === selectedDeviceId) || devices[0];
            const [currentStatus, setCurrentStatus] = useState(device.status.split('•')[0].trim());
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [isTabTransitioning, setIsTabTransitioning] = useState(false);
            const [selectedCard, setSelectedCard] = useState(null);
            const transitionRef = useRef(null);
            const isMountingRef = useRef(true);

            useEffect(() => {
                isMountingRef.current = false;
            }, []);

            const handleStatusChange = (newStatus) => {
                if (newStatus === currentStatus) return;

                if (transitionRef.current) clearTimeout(transitionRef.current);

                setIsTransitioning(true);
                transitionRef.current = setTimeout(() => {
                    setCurrentStatus(newStatus);
                    if (onUpdateStatus) onUpdateStatus(selectedDeviceId, newStatus);
                    setIsTransitioning(false);
                }, 500);
            };

            const handleTabChange = (tab) => {
                if (tab === activeTab) return;
                setIsTabTransitioning(true);
                setTimeout(() => {
                    setActiveTab(tab);
                    setIsTabTransitioning(false);
                }, 300);
            };

            const handleActivateMasterControl = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                if (transitionRef.current) clearTimeout(transitionRef.current);
                setIsTransitioning(false);

                // Directly switch status to Setup without transition for immediate feedback
                const newStatus = 'Ai - Setup';
                setCurrentStatus(newStatus);
                if (onUpdateStatus) onUpdateStatus(selectedDeviceId, newStatus);
            };

            const confirmMasterControl = () => {
                handleStatusChange('Ai - Data Optimizing');
            };

            const cancelMasterControl = () => {
                // Go back to monitoring
                const newStatus = 'Ai - Monitoring';
                setCurrentStatus(newStatus);
                if (onUpdateStatus) onUpdateStatus(selectedDeviceId, newStatus);
            };

            const tabContentClass = isTabTransitioning ? 'stagger-exit' : 'stagger-enter';

            return (
                <div>
                    <div className="header">
                        <div className="breadcrumbs">
                            <span>Hardware</span>
                            <i className="fa-solid fa-chevron-right" style={{ fontSize: '0.7rem' }}></i>
                            <span>{device.name}</span>
                        </div>
                        <StatusSelector
                            initialStatus={currentStatus}
                            onStatusChange={handleStatusChange}
                            optimizingLoading={optimizingLoading}
                            monitoringLoading={monitoringLoading}
                        />
                    </div>

                    <div className={isTransitioning ? 'stagger-exit' : 'stagger-enter'}>
                        {currentStatus === 'Offline' ? (
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                height: '60vh',
                                textAlign: 'center',
                                color: '#6b7280'
                            }}>
                                <div style={{
                                    fontSize: '4rem',
                                    marginBottom: '1.5rem',
                                    color: '#9ca3af'
                                }}>
                                    <i className="fa-solid fa-link-slash"></i>
                                </div>
                                <h2 style={{
                                    fontSize: '1.5rem',
                                    fontWeight: '600',
                                    color: '#111827',
                                    marginBottom: '0.5rem'
                                }}>
                                    Oops, your Device or Cloud is not connected.
                                </h2>
                                <p style={{ fontSize: '1rem' }}>
                                    Please check your internet connection or try again later.
                                </p>
                            </div>
                        ) : currentStatus === 'Ai - Setup' ? (
                            <AiMasterControlSetupView
                                onConfirm={confirmMasterControl}
                                onCancel={cancelMasterControl}
                                items={devices}
                                currentItemId={selectedDeviceId}
                                type="device"
                            />
                        ) : currentStatus === 'Ai - Data Optimizing' ? (
                            <AiOptimizationProcessView 
                                onLoadingStateChange={setOptimizingLoading} 
                                isInitialized={isOptimizingInitialized}
                                onInitialized={onOptimizingInitialized}
                                skipAnimation={isMountingRef.current}
                            />
                        ) : currentStatus === 'Ai - Monitoring' ? (
                            <AiMonitoringView
                                onActivate={handleActivateMasterControl}
                                items={devices}
                                currentItemId={selectedDeviceId}
                                type="device"
                                onLoadingStateChange={setMonitoringLoading}
                                isInitialized={isMonitoringInitialized}
                                onInitialized={onMonitoringInitialized}
                                skipAnimation={isMountingRef.current}
                            />
                        ) : (
                            <React.Fragment>
                                <div className="hero-wrapper">
                                    <Hero device={device} />
                                </div>

                                <div className="nav-wrapper">
                                    <TabNavigation activeTab={activeTab} setActiveTab={handleTabChange} />
                                </div>

                                <div className="content-wrapper">
                                    {activeTab === 'Overview' && (
                                        <React.Fragment>
                                            <div className={`dashboard-grid ${tabContentClass}`}>
                                                <div className="card" onClick={() => setSelectedCard({ title: 'Disk Health', type: 'health', data: device.stats.diskHealth, icon: 'fa-heart-pulse', iconBg: '#dcfce7', iconColor: '#16a34a' })} style={{ cursor: 'pointer' }}>
                                                    <div className="card-header">
                                                        <div className="card-icon icon-green">
                                                            <i className="fa-solid fa-heart-pulse"></i>
                                                        </div>
                                                        <span className="tag">Health</span>
                                                    </div>
                                                    <div>
                                                        <div className="card-title">Disk Health</div>
                                                        <div className="card-value" style={{ color: '#111827' }}>
                                                            {device.stats.diskHealth.value} <span className="card-subvalue" style={{ color: device.stats.diskHealth.color }}>{device.stats.diskHealth.status}</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="card" onClick={() => setSelectedCard({ title: 'Storage Used', type: 'storage', data: device.stats.storage, icon: 'fa-hard-drive', iconBg: '#dbeafe', iconColor: '#2563eb' })} style={{ cursor: 'pointer' }}>
                                                    <div className="card-header">
                                                        <div className="card-icon icon-blue">
                                                            <i className="fa-solid fa-hard-drive"></i>
                                                        </div>
                                                        <span className="tag">{device.stats.storage.total} Total</span>
                                                    </div>
                                                    <div>
                                                        <div className="card-title">Storage Used</div>
                                                        <div className="card-value">
                                                            {device.stats.storage.used} <span className="card-subvalue">{device.stats.storage.percent}%</span>
                                                        </div>
                                                        <div className="progress-bar">
                                                            <div className="progress-fill" style={{ width: `${device.stats.storage.percent}%` }}></div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="card" onClick={() => setSelectedCard({ title: 'Backup Status', type: 'backup', data: device.stats.backup, icon: 'fa-cloud-arrow-up', iconBg: '#f3e8ff', iconColor: '#9333ea' })} style={{ cursor: 'pointer' }}>
                                                    <div className="card-header">
                                                        <div className="card-icon icon-purple">
                                                            <i className="fa-solid fa-cloud-arrow-up"></i>
                                                        </div>
                                                        <span className="tag" style={{ color: '#3b82f6', cursor: 'pointer' }}>Backup Now</span>
                                                    </div>
                                                    <div>
                                                        <div className="card-title">Backup Status</div>
                                                        <div className="card-value" style={{ fontSize: '1.5rem' }}>
                                                            {device.stats.backup.last}
                                                        </div>
                                                        <div className="card-subvalue" style={{ fontSize: '0.75rem', marginTop: '0.25rem' }}>
                                                            Next scheduled: {device.stats.backup.next}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className={`bottom-grid ${tabContentClass}`}>
                                                <div className="system-load">
                                                    <div className="section-header">
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontWeight: '700', fontSize: '1.1rem' }}>
                                                            <i className="fa-solid fa-microchip" style={{ color: '#6b7280' }}></i>
                                                            System Load
                                                        </div>
                                                        <span className="tag" style={{ backgroundColor: '#d1fae5', color: '#10b981' }}>Optimal</span>
                                                    </div>

                                                    <div className="load-item">
                                                        <div className="load-info">
                                                            <span>CPU Usage</span>
                                                            <span>{device.load.cpu}%</span>
                                                        </div>
                                                        <div className="progress-bar">
                                                            <div className="progress-fill" style={{ width: `${device.load.cpu}%`, backgroundColor: '#3b82f6', opacity: 0.7 }}></div>
                                                        </div>
                                                    </div>

                                                    <div className="load-item">
                                                        <div className="load-info">
                                                            <span>Memory Pressure</span>
                                                            <span>{device.load.memory}%</span>
                                                        </div>
                                                        <div className="progress-bar">
                                                            <div className="progress-fill" style={{ width: `${device.load.memory}%`, backgroundColor: '#a855f7', opacity: 0.7 }}></div>
                                                        </div>
                                                    </div>

                                                    <div className="load-item">
                                                        <div className="load-info">
                                                            <span>Network Bandwidth</span>
                                                            <span>{device.load.networkSpeed}</span>
                                                        </div>
                                                        <div className="progress-bar">
                                                            <div className="progress-fill" style={{ width: `${device.load.network}%`, backgroundColor: '#10b981', opacity: 0.7 }}></div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="ai-optimizer">
                                                    <div>
                                                        <div className="ai-header">
                                                            <i className="fa-solid fa-wand-magic-sparkles"></i>
                                                            AI OPTIMIZER
                                                        </div>
                                                        <div className="ai-title" style={{ fontSize: '1.25rem' }}>
                                                            {device.ai.title}
                                                        </div>
                                                        <div className="ai-desc">
                                                            {device.ai.desc}
                                                        </div>
                                                    </div>
                                                    <button 
                                                        className="optimize-btn"
                                                        onClick={() => handleStatusChange('Ai - Data Optimizing')}
                                                    >
                                                        Optimize Now <i className="fa-solid fa-bolt"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </React.Fragment>
                                    )}

                                    {activeTab === 'Security' && (
                                        <div className={`dashboard-grid ${tabContentClass}`} style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))' }}>
                                            <div className="card" onClick={() => setSelectedCard({ title: 'Security Status', type: 'security', data: device.security, icon: 'fa-shield-halved', iconBg: '#dcfce7', iconColor: '#16a34a' })} style={{ cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#dcfce7', color: '#16a34a' }}>
                                                        <i className="fa-solid fa-shield-halved"></i>
                                                    </div>
                                                    <span className="tag">Score: {device.security.score}/100</span>
                                                </div>
                                                <div className="card-title">Security Status</div>
                                                <div className="card-value" style={{ fontSize: '1.2rem' }}>
                                                    {device.security.score >= 90 ? 'Protected' : 'Attention Needed'}
                                                </div>
                                                <div className="card-subvalue">Last scan: {device.security.lastScan}</div>
                                            </div>

                                            <div className="card" onClick={() => setSelectedCard({ title: 'Encryption', type: 'encryption', data: { status: 'Active', type: device.security.encryption }, icon: 'fa-lock', iconBg: '#e0e7ff', iconColor: '#4f46e5' })} style={{ cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#e0e7ff', color: '#4f46e5' }}>
                                                        <i className="fa-solid fa-lock"></i>
                                                    </div>
                                                    <span className="tag">{device.security.encryption}</span>
                                                </div>
                                                <div className="card-title">Encryption</div>
                                                <div className="card-value" style={{ fontSize: '1.2rem' }}>Active</div>
                                                <div className="card-subvalue">Data is encrypted at rest</div>
                                            </div>

                                            <div className="card" onClick={() => setSelectedCard({ title: 'Threat Detection', type: 'threats', data: device.security.issues, icon: 'fa-bug', iconBg: '#fee2e2', iconColor: '#dc2626' })} style={{ cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#fee2e2', color: '#dc2626' }}>
                                                        <i className="fa-solid fa-bug"></i>
                                                    </div>
                                                    <span className="tag">{device.security.antivirus}</span>
                                                </div>
                                                <div className="card-title">Threat Detection</div>
                                                <div className="card-value" style={{ fontSize: '1.2rem' }}>
                                                    {device.security.issues.length === 0 ? 'No Threats' : `${device.security.issues.length} Issues`}
                                                </div>
                                                <div className="card-subvalue">Real-time protection on</div>
                                            </div>

                                            <div className="card" onClick={() => setSelectedCard({ title: 'Audit Log', type: 'audit', data: [], icon: 'fa-list-check', iconBg: '#f3f4f6', iconColor: '#4b5563' })} style={{ gridColumn: '1 / -1', cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#f3f4f6', color: '#4b5563' }}>
                                                        <i className="fa-solid fa-list-check"></i>
                                                    </div>
                                                    <span className="tag">Audit Log</span>
                                                </div>
                                                <div style={{ marginTop: '1rem' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', borderBottom: '1px solid #f3f4f6' }}>
                                                        <span style={{ fontWeight: 500 }}>System Scan</span>
                                                        <span style={{ color: '#6b7280' }}>Completed successfully</span>
                                                        <span style={{ color: '#9ca3af' }}>10 mins ago</span>
                                                    </div>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0', borderBottom: '1px solid #f3f4f6' }}>
                                                        <span style={{ fontWeight: 500 }}>Firewall Update</span>
                                                        <span style={{ color: '#6b7280' }}>Rules updated</span>
                                                        <span style={{ color: '#9ca3af' }}>2 hours ago</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'Performance' && (
                                        <div className={`dashboard-grid ${tabContentClass}`}>
                                            <div className="card" onClick={() => setSelectedCard({ title: 'System Uptime', type: 'uptime', data: device.performance.uptime, icon: 'fa-clock', iconBg: '#ffedd5', iconColor: '#ea580c' })} style={{ cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#ffedd5', color: '#ea580c' }}>
                                                        <i className="fa-solid fa-clock"></i>
                                                    </div>
                                                </div>
                                                <div className="card-title">System Uptime</div>
                                                <div className="card-value" style={{ fontSize: '1.5rem' }}>{device.performance.uptime}</div>
                                            </div>

                                            <div className="card" onClick={() => setSelectedCard({ title: 'Temperature', type: 'temperature', data: device.performance.temperature, icon: 'fa-temperature-half', iconBg: '#fae8ff', iconColor: '#c026d3' })} style={{ cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#fae8ff', color: '#c026d3' }}>
                                                        <i className="fa-solid fa-temperature-half"></i>
                                                    </div>
                                                </div>
                                                <div className="card-title">Temperature</div>
                                                <div className="card-value" style={{ fontSize: '1.5rem' }}>{device.performance.temperature}</div>
                                            </div>

                                            <div className="card" onClick={() => setSelectedCard({ title: 'Active Processes', type: 'processes', data: device.performance.processes, icon: 'fa-list-ol', iconBg: '#dbeafe', iconColor: '#2563eb' })} style={{ cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#dbeafe', color: '#2563eb' }}>
                                                        <i className="fa-solid fa-list-ol"></i>
                                                    </div>
                                                </div>
                                                <div className="card-title">Active Processes</div>
                                                <div className="card-value" style={{ fontSize: '1.5rem' }}>{device.performance.processes}</div>
                                            </div>

                                            <div className="card" onClick={() => setSelectedCard({ title: 'Top Resource Consumers', type: 'topApps', data: device.performance.topApps, icon: 'fa-chart-pie', iconBg: '#f3f4f6', iconColor: '#4b5563' })} style={{ gridColumn: '1 / -1', cursor: 'pointer' }}>
                                                <div className="card-header">
                                                    <span className="tag">Top Resource Consumers</span>
                                                </div>
                                                <div style={{ marginTop: '1rem' }}>
                                                    {device.performance.topApps.length > 0 ? (
                                                        device.performance.topApps.map((app, idx) => (
                                                            <div key={idx} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0.75rem 0', borderBottom: '1px solid #f3f4f6' }}>
                                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                                    <div style={{ width: '8px', height: '8px', borderRadius: '50%', backgroundColor: idx === 0 ? '#ef4444' : '#f59e0b' }}></div>
                                                                    <span style={{ fontWeight: 600 }}>{app.name}</span>
                                                                </div>
                                                                <div style={{ display: 'flex', gap: '1.5rem', fontSize: '0.9rem' }}>
                                                                    <span style={{ color: '#6b7280' }}>CPU: <span style={{ color: '#111827', fontWeight: 500 }}>{app.cpu}</span></span>
                                                                    <span style={{ color: '#6b7280' }}>Mem: <span style={{ color: '#111827', fontWeight: 500 }}>{app.mem}</span></span>
                                                                </div>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div style={{ color: '#9ca3af', textAlign: 'center', padding: '1rem' }}>No active high-resource processes</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'AI Insights' && (
                                        <div className={`dashboard-grid ${tabContentClass}`} style={{ gridTemplateColumns: '1fr' }}>
                                            <div className="ai-optimizer" style={{ marginBottom: '0' }}>
                                                <div>
                                                    <div className="ai-header">
                                                        <i className="fa-solid fa-wand-magic-sparkles"></i>
                                                        CURRENT RECOMMENDATION
                                                    </div>
                                                    <div className="ai-title" style={{ fontSize: '1.5rem' }}>
                                                        {device.ai.title}
                                                    </div>
                                                    <div className="ai-desc" style={{ fontSize: '1rem' }}>
                                                        {device.ai.desc}
                                                    </div>
                                                </div>
                                                <button 
                                                    className="optimize-btn" 
                                                    style={{ maxWidth: '200px' }}
                                                    onClick={() => handleStatusChange('Ai - Monitoring')}
                                                >
                                                    Apply Fix <i className="fa-solid fa-bolt"></i>
                                                </button>
                                            </div>

                                            <div className="card">
                                                <div className="card-header">
                                                    <div className="card-icon" style={{ backgroundColor: '#f0fdf4', color: '#16a34a' }}>
                                                        <i className="fa-solid fa-clock-rotate-left"></i>
                                                    </div>
                                                    <span className="tag">Optimization History</span>
                                                </div>
                                                <div style={{ marginTop: '1rem' }}>
                                                    {device.aiInsights.history.map((item, idx) => (
                                                        <div key={idx} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '1rem 0', borderBottom: '1px solid #f3f4f6' }}>
                                                            <div>
                                                                <div style={{ fontWeight: 600, marginBottom: '0.25rem' }}>{item.action}</div>
                                                                <div style={{ fontSize: '0.8rem', color: '#9ca3af' }}>{item.date}</div>
                                                            </div>
                                                            <div style={{ backgroundColor: '#ecfdf5', color: '#059669', padding: '0.25rem 0.75rem', borderRadius: '15px', fontSize: '0.8rem', fontWeight: 500 }}>
                                                                {item.impact}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </React.Fragment>
                        )}
                    </div>

                    {/* MasterControlModal removed from here as it is now inline */}
                    
                    {selectedCard && (
                        <CardDetailModal 
                            card={selectedCard} 
                            onClose={() => setSelectedCard(null)} 
                        />
                    )}
                </div>
            );
        };

        const OnboardingModal = ({ isOpen, onClose, onComplete, type }) => {
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [verificationStep, setVerificationStep] = useState('ask'); // 'ask', 'verifying', 'filled'
            const [deviceName, setDeviceName] = useState('Test_Device');

            useEffect(() => {
                if (isOpen) {
                    setStep(1);
                    setLoading(false);
                    setVerificationStep('ask');
                    setDeviceName('Test_Device');
                }
            }, [isOpen]);

            const totalSteps = type === 'device' ? 4 : 3;

            const handleNext = () => {
                // Special handling for Device Step 2
                if (step === 2 && type === 'device') {
                    if (verificationStep === 'ask') {
                        setVerificationStep('verifying');
                        // Simulate auto-fill after 1.5s
                        setTimeout(() => {
                            setVerificationStep('filled');
                            // Move to next step shortly after filling
                            setTimeout(() => {
                                setStep(3);
                            }, 800);
                        }, 1500);
                        return;
                    }
                }

                setLoading(true);
                setTimeout(() => {
                    setLoading(false);
                    if (step < totalSteps) {
                        setStep(step + 1);
                    } else {
                        onComplete(deviceName);
                    }
                }, 1500);
            };

            if (!isOpen) return null;

            // Helper to determine content based on step/type
            const getStepContent = () => {
                if (step === 1) {
                    return {
                        icon: type === 'device' ? 'fa-laptop' : 'fa-cloud',
                        title: type === 'device' ? 'Scanning Network' : 'Select Provider',
                        desc: type === 'device' ? 'Looking for compatible devices nearby...' : 'Searching for available cloud services...',
                        btnText: 'Continue'
                    };
                }
                if (step === 2) {
                    if (type === 'device') {
                        if (verificationStep === 'ask') {
                            return {
                                icon: 'fa-mobile-screen',
                                title: 'Test Device',
                                desc: 'Is this your device?',
                                btnText: 'Yes'
                            };
                        } else {
                            return {
                                icon: 'fa-mobile-screen',
                                title: 'Verifying',
                                desc: 'Enter the code displayed on your device',
                                btnText: null
                            };
                        }
                    }
                    return {
                        icon: 'fa-cloud',
                        title: 'Connecting API',
                        desc: 'Establishing secure connection...',
                        btnText: 'Continue'
                    };
                }
                if (step === 3) {
                    if (type === 'device') {
                        return {
                            icon: 'fa-pen',
                            title: 'Name Device',
                            desc: 'Give your device a recognizable name',
                            btnText: 'Continue'
                        };
                    }
                    return {
                        icon: 'fa-check',
                        title: 'Finalizing Setup',
                        desc: 'Syncing dashboard preferences...',
                        btnText: 'Finish'
                    };
                }
                if (step === 4) {
                    return {
                        icon: 'fa-check',
                        title: 'Finalizing Setup',
                        desc: 'Syncing dashboard preferences...',
                        btnText: 'Finish'
                    };
                }
            };

            const content = getStepContent();
            const stepsArray = type === 'device' ? [1, 2, 3, 4] : [1, 2, 3];

            return (
                <div className="modal-overlay" style={{ flexDirection: 'column' }}>
                    <div className="modal-content">
                        <div className="step-indicator">
                            {stepsArray.map(s => (
                                <div key={s} className={`step-dot ${step >= s ? 'active' : ''}`}></div>
                            ))}
                        </div>

                        <div style={{ textAlign: 'center' }}>
                            <div style={{
                                width: '80px', height: '80px', background: '#e5e7eb', borderRadius: '50%',
                                margin: '0 auto 1.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: '2rem', color: '#6b7280'
                            }}>
                                {loading ? <i className="fa-solid fa-circle-notch fa-spin"></i> :
                                    <i className={`fa-solid ${content.icon}`}></i>}
                            </div>

                            <h3 style={{ fontSize: '1.25rem', fontWeight: '700', marginBottom: '0.5rem', color: '#111827' }}>
                                {content.title}
                            </h3>

                            <p style={{ color: '#6b7280', marginBottom: '2rem', fontSize: '0.875rem', lineHeight: '1.5' }}>
                                {content.desc}
                            </p>

                            {/* Special Verification Input for Step 2 Device */}
                            {step === 2 && type === 'device' && verificationStep !== 'ask' && (
                                <div style={{ marginBottom: '2rem' }}>
                                    <input
                                        type="text"
                                        value={verificationStep === 'filled' ? '*** ***' : ''}
                                        readOnly
                                        style={{
                                            fontSize: '2rem', letterSpacing: '0.5rem', textAlign: 'center',
                                            width: '100%', border: 'none', background: 'transparent', outline: 'none',
                                            fontFamily: 'monospace', color: '#111827', fontWeight: 'bold'
                                        }}
                                        placeholder="_ _ _  _ _ _"
                                    />
                                </div>
                            )}

                            {/* Name Input for Step 3 Device */}
                            {step === 3 && type === 'device' && (
                                <div style={{ marginBottom: '2rem' }}>
                                    <input
                                        type="text"
                                        value={deviceName}
                                        onChange={(e) => setDeviceName(e.target.value)}
                                        style={{
                                            width: '100%', padding: '0.75rem', borderRadius: '8px',
                                            border: '1px solid #d1d5db', fontSize: '1rem', textAlign: 'center',
                                            color: '#111827', fontWeight: '500'
                                        }}
                                    />
                                </div>
                            )}

                            {/* Button - Hide if in auto-verification process */}
                            {!(step === 2 && type === 'device' && verificationStep !== 'ask') && (
                                <button
                                    onClick={handleNext}
                                    disabled={loading}
                                    style={{
                                        width: '100%', padding: '1rem', borderRadius: '12px', border: 'none',
                                        background: '#111827', color: 'white', fontWeight: '600', cursor: loading ? 'not-allowed' : 'pointer',
                                        opacity: loading ? 0.7 : 1, transition: 'all 0.2s'
                                    }}
                                >
                                    {loading ? 'Processing...' : content.btnText}
                                </button>
                            )}
                        </div>
                    </div>
                    <button onClick={onClose} style={{
                        marginTop: '1.5rem',
                        width: '48px', height: '48px', borderRadius: '50%',
                        backgroundColor: 'white', border: 'none',
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: '1.25rem', color: '#6b7280', cursor: 'pointer',
                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        transition: 'transform 0.2s'
                    }}
                    onMouseEnter={e => e.currentTarget.style.transform = 'scale(1.1)'}
                    onMouseLeave={e => e.currentTarget.style.transform = 'scale(1)'}
                    >
                        <i className="fa-solid fa-xmark"></i>
                    </button>
                </div>
            );
        };

        const CloudDashboard = ({ selectedCloudId, clouds, onUpdateStatus, setOptimizingLoading, optimizingLoading, setMonitoringLoading, monitoringLoading }) => {
            const [activeTab, setActiveTab] = useState('Overview');
            const cloud = clouds.find(c => c.id === selectedCloudId) || clouds[0];
            // Removed local state currentStatus, using cloud.status instead
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [isTabTransitioning, setIsTabTransitioning] = useState(false);
            const [selectedCard, setSelectedCard] = useState(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [activeBarIndex, setActiveBarIndex] = useState(null);
            const transitionRef = useRef(null);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // Mock data for cloud
            const cloudStats = {
                storage: { used: '450 GB', total: '2 TB', percent: 22 },
                api: { requests: '1.2M', latency: '45ms', errors: '0.01%' },
                cost: { current: '$45.20', projected: '$120.00' }
            };

            const handleStatusChange = (newStatus) => {
                if (newStatus === cloud.status) return;

                if (transitionRef.current) clearTimeout(transitionRef.current);

                setIsTransitioning(true);
                transitionRef.current = setTimeout(() => {
                    onUpdateStatus(cloud.id, newStatus);
                    setIsTransitioning(false);
                }, 500);
            };

            const handleAiActivate = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                if (transitionRef.current) clearTimeout(transitionRef.current);
                setIsTransitioning(false);

                onUpdateStatus(cloud.id, 'Ai - Setup');
            };

            const handleMasterControlConfirm = () => {
                handleStatusChange('Ai - Data Optimizing');
            };

            const cancelMasterControl = () => {
                onUpdateStatus(cloud.id, 'Ai - Monitoring');
            };

            const handleTabChange = (tab) => {
                if (tab === activeTab) return;
                setIsTabTransitioning(true);
                setTimeout(() => {
                    setActiveTab(tab);
                    setIsTabTransitioning(false);
                }, 300);
            };

            const tabContentClass = isTabTransitioning ? 'stagger-exit' : 'stagger-enter';

            return (
                <div>
                    <div className="header">
                        <div className="breadcrumbs">
                            <span>Cloud Services</span>
                            <i className="fa-solid fa-chevron-right" style={{ fontSize: '0.7rem' }}></i>
                            <span>{cloud.name}</span>
                        </div>
                        <StatusSelector
                            initialStatus={cloud.status}
                            onStatusChange={handleStatusChange}
                            optimizingLoading={optimizingLoading}
                            monitoringLoading={monitoringLoading}
                        />
                    </div>

                    <div className={isTransitioning ? 'stagger-exit' : 'stagger-enter'}>
                        {cloud.status === 'Ai - Setup' ? (
                            <AiMasterControlSetupView
                                onConfirm={handleMasterControlConfirm}
                                onCancel={cancelMasterControl}
                                items={clouds}
                                currentItemId={cloud.id}
                                type="cloud"
                            />
                        ) : cloud.status === 'Ai - Data Optimizing' ? (
                            <AiOptimizationProcessView onLoadingStateChange={setOptimizingLoading} type="cloud" />
                        ) : cloud.status === 'Ai - Monitoring' ? (
                            <AiMonitoringView
                                onActivate={handleAiActivate}
                                items={clouds}
                                currentItemId={cloud.id}
                                type="cloud"
                                onLoadingStateChange={setMonitoringLoading}
                            />
                        ) : cloud.status === 'Offline' ? (
                            <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                height: '60vh',
                                textAlign: 'center',
                                color: '#6b7280'
                            }}>
                                <div style={{
                                    fontSize: '4rem',
                                    marginBottom: '1.5rem',
                                    color: '#9ca3af'
                                }}>
                                    <i className="fa-solid fa-link-slash"></i>
                                </div>
                                <h2 style={{
                                    fontSize: '1.5rem',
                                    fontWeight: '600',
                                    color: '#111827',
                                    marginBottom: '0.5rem'
                                }}>
                                    Cloud Service Disconnected
                                </h2>
                                <p style={{ fontSize: '1rem' }}>
                                    Unable to reach API endpoints. Check configuration.
                                </p>
                            </div>
                        ) : (
                            <React.Fragment>
                                <div className="hero-card" style={{ background: 'linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%)', color: 'white', display: 'flex', flexDirection: 'column', alignItems: 'stretch' }}>
                                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '1rem', marginBottom: '1rem' }}>
                                            {isMobile ? (
                                                <React.Fragment>
                                                    <div style={{ background: 'rgba(255,255,255,0.2)', padding: '1rem', borderRadius: '12px' }}>
                                                        <i className={cloud.icon} style={{ fontSize: '2rem' }}></i>
                                                    </div>
                                                    <div style={{ textAlign: 'right' }}>
                                                        <h1 style={{ fontSize: '2rem', fontWeight: '700', margin: 0 }}>{cloud.name}</h1>
                                                    </div>
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    <div>
                                                        <h1 style={{ fontSize: '2rem', fontWeight: '700', margin: 0 }}>{cloud.name}</h1>
                                                        <div style={{ opacity: 0.8 }}>API v2.4 • Region: us-east-1</div>
                                                    </div>
                                                    <div style={{ background: 'rgba(255,255,255,0.2)', padding: '1rem', borderRadius: '12px' }}>
                                                        <i className={cloud.icon} style={{ fontSize: '2rem' }}></i>
                                                    </div>
                                                </React.Fragment>
                                            )}
                                        </div>
                                        <div className="specs-grid" style={{ marginTop: isMobile ? 'auto' : '2rem', marginBottom: isMobile ? '1rem' : '0' }}>
                                            <div className="spec-item">
                                                <h4 style={{ color: 'rgba(255,255,255,0.7)' }}>Uptime</h4>
                                                <p>99.99%</p>
                                            </div>
                                            <div className="spec-item">
                                                <h4 style={{ color: 'rgba(255,255,255,0.7)' }}>Latency</h4>
                                                <p>{cloudStats.api.latency}</p>
                                            </div>
                                            <div className="spec-item">
                                                <h4 style={{ color: 'rgba(255,255,255,0.7)' }}>Requests</h4>
                                                <p>{cloudStats.api.requests}</p>
                                            </div>
                                            <div className="spec-item">
                                                <h4 style={{ color: 'rgba(255,255,255,0.7)' }}>Status</h4>
                                                <div className="warranty-active" style={{ color: '#86efac' }}>
                                                    <i className="fa-solid fa-check-circle"></i> Healthy
                                                </div>
                                            </div>
                                        </div>
                                        {isMobile && (
                                            <div style={{ opacity: 0.8, textAlign: 'center', marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid rgba(255,255,255,0.2)' }}>
                                                API v2.4 • Region: us-east-1
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="nav-wrapper">
                                    <div className="tabs" style={{ display: 'flex', gap: '0.5rem', background: '#e5e7eb', padding: '0.25rem', borderRadius: '50px', width: '100%', marginBottom: '2rem' }}>
                                        {[
                                            { id: 'Overview', icon: 'fa-border-all' },
                                            { id: 'API Usage', icon: 'fa-code' },
                                            { id: 'Storage', icon: 'fa-database' },
                                            { id: 'Settings', icon: 'fa-gear' }
                                        ].map(tab => (
                                            <button
                                                key={tab.id}
                                                className={`tab ${activeTab === tab.id ? 'active' : ''}`}
                                                onClick={() => handleTabChange(tab.id)}
                                                style={{
                                                    position: 'relative',
                                                    zIndex: 1,
                                                    background: activeTab === tab.id ? 'white' : 'transparent',
                                                    border: 'none',
                                                    color: activeTab === tab.id ? '#111827' : '#6b7280',
                                                    transition: 'all 0.2s',
                                                    cursor: 'pointer',
                                                    padding: '0.5rem 0',
                                                    borderRadius: '50px',
                                                    fontSize: '0.875rem',
                                                    fontWeight: '500',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    gap: '0.5rem',
                                                    flex: 1,
                                                    boxShadow: activeTab === tab.id ? '0 1px 2px rgba(0,0,0,0.1)' : 'none'
                                                }}
                                            >
                                                <i className={`fa-solid ${tab.icon}`}></i>
                                                <span className="tab-text">{tab.id}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {activeTab === 'Overview' && (
                                    <div className={`dashboard-grid ${tabContentClass}`}>
                                    <div className="card" onClick={() => setSelectedCard({ title: 'Cloud Storage', type: 'storage', data: cloudStats.storage, icon: 'fa-database', iconBg: '#dbeafe', iconColor: '#2563eb' })} style={{ cursor: 'pointer' }}>
                                        <div className="card-header">
                                            <div className="card-icon icon-blue">
                                                <i className="fa-solid fa-database"></i>
                                            </div>
                                            <span className="tag">Storage</span>
                                        </div>
                                        <div>
                                            <div className="card-title">Cloud Storage</div>
                                            <div className="card-value">
                                                {cloudStats.storage.used} <span className="card-subvalue">/ {cloudStats.storage.total}</span>
                                            </div>
                                            <div className="progress-bar">
                                                <div className="progress-fill" style={{ width: `${cloudStats.storage.percent}%` }}></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="card" onClick={() => setSelectedCard({ title: 'API Requests', type: 'api', data: cloudStats.api, icon: 'fa-globe', iconBg: '#dcfce7', iconColor: '#16a34a' })} style={{ cursor: 'pointer' }}>
                                        <div className="card-header">
                                            <div className="card-icon icon-green">
                                                <i className="fa-solid fa-globe"></i>
                                            </div>
                                            <span className="tag">Network</span>
                                        </div>
                                        <div>
                                            <div className="card-title">API Requests (24h)</div>
                                            <div className="card-value">
                                                {cloudStats.api.requests}
                                            </div>
                                            <div className="card-subvalue" style={{ color: '#10b981' }}>
                                                <i className="fa-solid fa-arrow-trend-up"></i> +12% vs last week
                                            </div>
                                        </div>
                                    </div>

                                    <div className="card" onClick={() => setSelectedCard({ title: 'Billing', type: 'cost', data: cloudStats.cost, icon: 'fa-receipt', iconBg: '#fae8ff', iconColor: '#c026d3' })} style={{ cursor: 'pointer' }}>
                                        <div className="card-header">
                                            <div className="card-icon icon-purple">
                                                <i className="fa-solid fa-receipt"></i>
                                            </div>
                                            <span className="tag">Billing</span>
                                        </div>
                                        <div>
                                            <div className="card-title">Current Month</div>
                                            <div className="card-value">
                                                {cloudStats.cost.current}
                                            </div>
                                            <div className="card-subvalue">
                                                Projected: {cloudStats.cost.projected}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                )}

                                {activeTab === 'API Usage' && (
                                    <div className={`dashboard-grid ${tabContentClass}`} style={{ gridTemplateColumns: '1fr' }}>
                                        <div className="card">
                                            <div className="card-header">
                                                <div className="card-icon icon-blue"><i className="fa-solid fa-chart-line"></i></div>
                                                <span className="tag">Traffic Analysis</span>
                                            </div>
                                            <div style={{ height: '200px', display: 'flex', alignItems: 'flex-end', gap: '10px', padding: '1rem 0', paddingTop: '2.5rem' }}>
                                                {[40, 65, 45, 80, 55, 90, 70].map((h, i) => (
                                                    <div 
                                                        key={i} 
                                                        onMouseEnter={() => !isMobile && setActiveBarIndex(i)}
                                                        onMouseLeave={() => !isMobile && setActiveBarIndex(null)}
                                                        onClick={() => isMobile && setActiveBarIndex(activeBarIndex === i ? null : i)}
                                                        style={{ 
                                                            flex: 1, 
                                                            background: activeBarIndex === i ? '#bfdbfe' : '#e0f2fe', 
                                                            borderRadius: '4px', 
                                                            height: `${h}%`, 
                                                            position: 'relative',
                                                            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                                            transform: activeBarIndex === i ? 'scaleY(1.1) scaleX(1.05)' : 'scale(1)',
                                                            transformOrigin: 'bottom',
                                                            cursor: 'pointer',
                                                            zIndex: activeBarIndex === i ? 10 : 1
                                                        }}
                                                    >
                                                        {activeBarIndex === i && (
                                                            <div style={{
                                                                position: 'absolute',
                                                                top: '-35px',
                                                                left: '50%',
                                                                transform: 'translateX(-50%) scaleY(0.909)', // Counteract parent scaleY (1/1.1)
                                                                background: '#1e293b',
                                                                color: 'white',
                                                                padding: '4px 8px',
                                                                borderRadius: '4px',
                                                                fontSize: '0.75rem',
                                                                fontWeight: '600',
                                                                whiteSpace: 'nowrap',
                                                                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                                                animation: 'fadeIn 0.2s ease-out',
                                                                pointerEvents: 'none'
                                                            }}>
                                                                {h}%
                                                                <div style={{
                                                                    position: 'absolute',
                                                                    bottom: '-4px',
                                                                    left: '50%',
                                                                    transform: 'translateX(-50%) rotate(45deg)',
                                                                    width: '8px',
                                                                    height: '8px',
                                                                    background: '#1e293b'
                                                                }}></div>
                                                            </div>
                                                        )}
                                                        <div style={{ 
                                                            position: 'absolute', 
                                                            bottom: 0, 
                                                            width: '100%', 
                                                            background: '#3b82f6', 
                                                            height: '30%', 
                                                            borderRadius: '4px', 
                                                            opacity: activeBarIndex === i ? 0.9 : 0.6,
                                                            transition: 'opacity 0.3s'
                                                        }}></div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: '#6b7280' }}>
                                                <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                                            </div>
                                        </div>
                                        <div className="card">
                                            <div className="card-header">
                                                <div className="card-icon icon-blue"><i className="fa-solid fa-list-check"></i></div>
                                                <span className="tag">Recent Requests</span>
                                            </div>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', marginTop: '1rem' }}>
                                                {[
                                                    { path: '/api/v1/users', status: 200, time: '24ms' },
                                                    { path: '/api/v1/auth', status: 200, time: '120ms' },
                                                    { path: '/api/v1/upload', status: 201, time: '450ms' },
                                                    { path: '/api/v1/sync', status: 500, time: '20ms' },
                                                ].map((req, i) => (
                                                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem', background: '#f9fafb', borderRadius: '8px' }}>
                                                        <span style={{ fontFamily: 'monospace', fontSize: '0.9rem' }}>{req.path}</span>
                                                        <div style={{ display: 'flex', gap: '1rem' }}>
                                                            <span style={{ color: req.status === 200 || req.status === 201 ? '#16a34a' : '#ef4444', fontWeight: 600 }}>{req.status}</span>
                                                            <span style={{ color: '#6b7280' }}>{req.time}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'Storage' && (
                                    <div className={`dashboard-grid ${tabContentClass}`} style={{ gridTemplateColumns: '1fr' }}>
                                        <div className="card">
                                            <div className="card-header">
                                                <div className="card-icon icon-blue"><i className="fa-solid fa-box-archive"></i></div>
                                                <span className="tag">Buckets</span>
                                            </div>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '1rem', marginTop: '1rem' }}>
                                                {['assets-prod', 'user-uploads', 'logs-archive', 'backups-daily'].map((bucket, i) => (
                                                    <div key={i} style={{ padding: '1rem', border: '1px solid #e5e7eb', borderRadius: '12px', textAlign: 'center' }}>
                                                        <i className="fa-solid fa-folder-open" style={{ fontSize: '2rem', color: '#3b82f6', marginBottom: '0.5rem' }}></i>
                                                        <div style={{ fontWeight: 600, fontSize: '0.9rem' }}>{bucket}</div>
                                                        <div style={{ fontSize: '0.8rem', color: '#6b7280' }}>{Math.floor(Math.random() * 500)} GB</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'Settings' && (
                                    <div className={`dashboard-grid ${tabContentClass}`} style={{ gridTemplateColumns: '1fr' }}>
                                        <div className="card">
                                            <div className="card-header">
                                                <div className="card-icon icon-purple"><i className="fa-solid fa-key"></i></div>
                                                <span className="tag">API Configuration</span>
                                            </div>
                                            <div style={{ marginTop: '1rem' }}>
                                                <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: 500, marginBottom: '0.5rem' }}>API Key</label>
                                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                    <input type="password" value="sk_live_51Mz..." readOnly style={{ flex: 1, padding: '0.5rem', borderRadius: '8px', border: '1px solid #e5e7eb', background: '#f9fafb' }} />
                                                    <button style={{ padding: '0.5rem 1rem', background: '#3b82f6', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer' }}>Reveal</button>
                                                </div>
                                            </div>
                                            <div style={{ marginTop: '1rem' }}>
                                                <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: 500, marginBottom: '0.5rem' }}>Region</label>
                                                <select style={{ width: '100%', padding: '0.5rem', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
                                                    <option>US East (N. Virginia)</option>
                                                    <option>US West (Oregon)</option>
                                                    <option>EU (Frankfurt)</option>
                                                    <option>Asia Pacific (Seoul)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </React.Fragment>
                        )}
                    </div>

                    {/* MasterControlModal removed from here as it is now inline */}
                    
                    <CardDetailModal
                        card={selectedCard}
                        onClose={() => setSelectedCard(null)}
                    />
                </div>
            );
        };

        const App = () => {
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [selectedDeviceId, setSelectedDeviceId] = useState('macbook');
            const [selectedCloudId, setSelectedCloudId] = useState(null);
            const [currentView, setCurrentView] = useState('device'); // 'device' or 'cloud'
            const [isViewTransitioning, setIsViewTransitioning] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [optimizingLoadingMap, setOptimizingLoadingMap] = useState({});
            const [monitoringLoadingMap, setMonitoringLoadingMap] = useState({});
            const [optimizingInitializedMap, setOptimizingInitializedMap] = useState({});
            const [monitoringInitializedMap, setMonitoringInitializedMap] = useState({});

            const [devices, setDevices] = useState(devicesData);
            const [clouds, setClouds] = useState([
                { id: 'c1', icon: 'fa-brands fa-dropbox', name: 'Dropbox', active: false, status: 'Online' },
                { id: 'c2', icon: 'fa-brands fa-google-drive', name: 'Google Drive', active: false, status: 'Ai - Monitoring' },
                { id: 'c3', icon: 'fa-solid fa-cloud', name: 'iCloud', active: false, status: 'Offline' },
                { id: 'c4', icon: 'fa-brands fa-microsoft', name: 'Microsoft Azure', active: false, status: 'Ai - Data Optimizing' },
                { id: 'c5', icon: 'fa-brands fa-aws', name: 'AWS Production', active: false, status: 'Online' },
            ]);

            // Onboarding State
            const [onboardingOpen, setOnboardingOpen] = useState(false);
            const [onboardingType, setOnboardingType] = useState(null); // 'device' or 'cloud'

            // Real-time updates for Temperature and Processes
            useEffect(() => {
                const interval = setInterval(() => {
                    setDevices(prevDevices => prevDevices.map(device => {
                        if (!device.performance) return device;

                        let newPerformance = { ...device.performance };
                        let changed = false;

                        // Update Temperature
                        let tempStr = device.performance.temperature;
                        let currentTemp = parseFloat(tempStr);
                        
                        if (!isNaN(currentTemp)) {
                            // Change by small amount (e.g. -0.2 to +0.2)
                            const change = (Math.random() * 0.4) - 0.2; 
                            let newTemp = currentTemp + change;
                            // Keep 1 decimal place
                            newTemp = Math.round(newTemp * 10) / 10;
                            newPerformance.temperature = `${newTemp.toFixed(1)}°C`;
                            changed = true;
                        }

                        // Update Processes
                        let currentProc = device.performance.processes;
                        if (typeof currentProc === 'number') {
                             // Change by -1, 0, or 1
                             const procChange = Math.floor(Math.random() * 3) - 1; 
                             if (procChange !== 0) {
                                currentProc += procChange;
                                currentProc = Math.max(0, currentProc);
                                newPerformance.processes = currentProc;
                                changed = true;
                             }
                        }

                        if (changed) {
                            return { ...device, performance: newPerformance };
                        }
                        return device;
                    }));
                }, 2000); // Update every 2 seconds to be less chaotic

                return () => clearInterval(interval);
            }, []);

            const setDeviceOptimizingLoading = (id, isLoading) => {
                setOptimizingLoadingMap(prev => ({ ...prev, [id]: isLoading }));
            };

            const setDeviceMonitoringLoading = (id, isLoading) => {
                setMonitoringLoadingMap(prev => ({ ...prev, [id]: isLoading }));
            };

            const setDeviceOptimizingInitialized = (id, isInitialized) => {
                setOptimizingInitializedMap(prev => ({ ...prev, [id]: isInitialized }));
            };

            const setDeviceMonitoringInitialized = (id, isInitialized) => {
                setMonitoringInitializedMap(prev => ({ ...prev, [id]: isInitialized }));
            };

            const handleSelectDevice = (id) => {
                if (selectedDeviceId === id && currentView === 'device') return;

                setIsLoading(true);
                setTimeout(() => {
                    if (currentView !== 'device') {
                        setCurrentView('device');
                        setSelectedCloudId(null);
                    }
                    setSelectedDeviceId(id);
                    setIsLoading(false);
                }, 800); // Simulate loading delay
            };

            const handleSelectCloud = (id) => {
                if (selectedCloudId === id && currentView === 'cloud') return;

                setIsLoading(true);
                setTimeout(() => {
                    if (currentView !== 'cloud') {
                        setCurrentView('cloud');
                        setSelectedDeviceId(null);
                    }
                    setSelectedCloudId(id);
                    setIsLoading(false);
                }, 800); // Simulate loading delay
            };

            const handleAddDeviceClick = () => {
                setOnboardingType('device');
                setOnboardingOpen(true);
            };

            const handleAddCloudClick = () => {
                setOnboardingType('cloud');
                setOnboardingOpen(true);
            };

            const handleOnboardingComplete = (customName) => {
                if (onboardingType === 'device') {
                    const newId = `device-${Date.now()}`;
                    const newDevice = {
                        ...devices[0],
                        id: newId,
                        name: customName || 'New Device',
                        serial: 'PENDING',
                        status: 'Online',
                        image: 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80'
                    };
                    setDevices([...devices, newDevice]);
                    handleSelectDevice(newId);
                } else {
                    const newId = `cloud-${Date.now()}`;
                    const newCloud = {
                        id: newId,
                        icon: 'fa-solid fa-cloud',
                        name: 'New API Service',
                        active: false
                    };
                    setClouds([...clouds, newCloud]);
                    handleSelectCloud(newId);
                }
                setOnboardingOpen(false);
            };

            const handleUpdateDeviceStatus = (deviceId, newStatus) => {
                setDevices(prevDevices => prevDevices.map(d => 
                    d.id === deviceId ? { ...d, status: newStatus } : d
                ));
            };

            const handleUpdateCloudStatus = (cloudId, newStatus) => {
                setClouds(prevClouds => prevClouds.map(c => 
                    c.id === cloudId ? { ...c, status: newStatus } : c
                ));
            };

            const viewContentClass = isViewTransitioning ? 'stagger-exit' : 'stagger-enter';

            return (
                <React.Fragment>
                    <Sidebar
                        isOpen={sidebarOpen}
                        toggleSidebar={() => setSidebarOpen(!sidebarOpen)}
                        selectedDeviceId={selectedDeviceId}
                        onSelectDevice={handleSelectDevice}
                        devices={devices}
                        onReorderDevices={setDevices}
                        clouds={clouds}
                        onReorderClouds={setClouds}
                        onAddDevice={handleAddDeviceClick}
                        onAddCloud={handleAddCloudClick}
                        selectedCloudId={selectedCloudId}
                        onSelectCloud={handleSelectCloud}
                        optimizingLoadingMap={optimizingLoadingMap}
                        monitoringLoadingMap={monitoringLoadingMap}
                    />

                    <div className="main-content">
                        <div className="menu-toggle" onClick={() => setSidebarOpen(!sidebarOpen)} style={{ marginBottom: '1rem' }}>
                            <i className="fa-solid fa-bars"></i>
                        </div>
                        {isLoading ? (
                            <div style={{
                                display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                                height: '80vh', color: '#3b82f6'
                            }}>
                                <div style={{ fontSize: '3rem', marginBottom: '1.5rem' }}>
                                    <i className="fa-solid fa-circle-notch fa-spin"></i>
                                </div>
                                <h2 style={{ fontSize: '1.25rem', fontWeight: '600', color: '#111827' }}>Loading Dashboard...</h2>
                            </div>
                        ) : (
                            <div className={viewContentClass}>
                                {currentView === 'device' ? (
                                    <Dashboard 
                                        key={selectedDeviceId} 
                                        selectedDeviceId={selectedDeviceId} 
                                        devices={devices} 
                                        onUpdateStatus={handleUpdateDeviceStatus}
                                        setOptimizingLoading={(val) => setDeviceOptimizingLoading(selectedDeviceId, val)}
                                        optimizingLoading={optimizingLoadingMap[selectedDeviceId] || false}
                                        setMonitoringLoading={(val) => setDeviceMonitoringLoading(selectedDeviceId, val)}
                                        monitoringLoading={monitoringLoadingMap[selectedDeviceId] || false}
                                    />
                                ) : (
                                    <CloudDashboard 
                                        key={selectedCloudId} 
                                        selectedCloudId={selectedCloudId} 
                                        clouds={clouds}
                                        onUpdateStatus={handleUpdateCloudStatus}
                                        setOptimizingLoading={(val) => setDeviceOptimizingLoading(selectedCloudId, val)}
                                        optimizingLoading={optimizingLoadingMap[selectedCloudId] || false}
                                        setMonitoringLoading={(val) => setDeviceMonitoringLoading(selectedCloudId, val)}
                                        monitoringLoading={monitoringLoadingMap[selectedCloudId] || false}
                                    />
                                )}
                            </div>
                        )}
                    </div>

                    {sidebarOpen && (
                        <div
                            className="overlay"
                            onClick={() => setSidebarOpen(false)}
                        ></div>
                    )}

                    <OnboardingModal
                        isOpen={onboardingOpen}
                        onClose={() => setOnboardingOpen(false)}
                        onComplete={handleOnboardingComplete}
                        type={onboardingType}
                    />
                </React.Fragment>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>